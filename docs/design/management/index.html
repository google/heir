<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.113.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Ciphertext Management | HEIR</title><meta name=description content="On 2025-04-17, Hongren Zheng gave a talk overview of the ciphertext management system in the HEIR working group meeting. The video can be found here and the slides can be found here
Introduction To lower from user specified computation to FHE scheme operations, a compiler must insert ciphertext management operations to satisfy various requirements of the FHE scheme, like modulus switching, relinearization, and bootstrapping. In HEIR, such operations are modeled in a scheme-agnostic way in the mgmt dialect."><meta property="og:title" content="Ciphertext Management"><meta property="og:description" content="On 2025-04-17, Hongren Zheng gave a talk overview of the ciphertext management system in the HEIR working group meeting. The video can be found here and the slides can be found here
Introduction To lower from user specified computation to FHE scheme operations, a compiler must insert ciphertext management operations to satisfy various requirements of the FHE scheme, like modulus switching, relinearization, and bootstrapping. In HEIR, such operations are modeled in a scheme-agnostic way in the mgmt dialect."><meta property="og:type" content="article"><meta property="og:url" content="https://heir.dev/docs/design/management/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2025-10-17T09:48:09-07:00"><meta itemprop=name content="Ciphertext Management"><meta itemprop=description content="On 2025-04-17, Hongren Zheng gave a talk overview of the ciphertext management system in the HEIR working group meeting. The video can be found here and the slides can be found here
Introduction To lower from user specified computation to FHE scheme operations, a compiler must insert ciphertext management operations to satisfy various requirements of the FHE scheme, like modulus switching, relinearization, and bootstrapping. In HEIR, such operations are modeled in a scheme-agnostic way in the mgmt dialect."><meta itemprop=dateModified content="2025-10-17T09:48:09-07:00"><meta itemprop=wordCount content="1369"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Ciphertext Management"><meta name=twitter:description content="On 2025-04-17, Hongren Zheng gave a talk overview of the ciphertext management system in the HEIR working group meeting. The video can be found here and the slides can be found here
Introduction To lower from user specified computation to FHE scheme operations, a compiler must insert ciphertext management operations to satisfy various requirements of the FHE scheme, like modulus switching, relinearization, and bootstrapping. In HEIR, such operations are modeled in a scheme-agnostic way in the mgmt dialect."><link rel=preload href=/scss/main.min.dffc1689fd83830a5fb090d38ca9680587c322008ad97c675ee0ca22e5fb10d5.css as=style><link href=/scss/main.min.dffc1689fd83830a5fb090d38ca9680587c322008ad97c675ee0ca22e5fb10d5.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script>
<script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body class=td-page><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="32" height="32" fill="#fff" fill-opacity=".01"/><path d="M18.6889 10.124l7.7916 5.0511 2.6263-1.6684-2.6146-1.6779-7.8033-4.96754 2.8526 1.84162L18.6889 10.124z" fill="#efcf6f"/><path d="M29.1185 6.86125 18.6979.13981 16.06 1.79876 26.4922 8.52025l2.6263-1.659z" fill="#efcf6f"/><path d="M8.2405 6.74134 5.60033 5.07291 3.05751 6.79935 5.67334 8.49344 8.2405 6.74134z" fill="#ee958a"/><path d="M10.8697 8.49344 8.2405 10.124v3.3995l5.2049-3.3348-2.5757-1.69526z" fill="#ee958a"/><path d="M5.67334 8.49344 3.05751 6.79935 3.03318 23.4932l2.64016 1.6897V8.49344z" fill="#a32e24"/><path d="M29.1185 6.86126 26.4922 8.52025V11.8288l2.6263-1.6401V6.86126z" fill="#d38041"/><path d="M21.5415 8.70288 18.6889 6.86126V10.124l2.8526-1.42112z" fill="#d38041"/><path fill-rule="evenodd" clip-rule="evenodd" d="M8.2405 6.74134V10.124v3.3995l5.2049-3.3348V3.58723l2.6145-1.7885L16.1123 11.8484V18.467l-2.6158 1.6181L13.4574 13.5235 10.849 15.1694 8.2405 16.8152v6.678L5.67334 25.1829V8.49344L8.2405 6.74134z" fill="#dd583b"/><path d="M13.4965 20.0851 13.4574 13.5235 10.849 15.1694 10.8077 18.467l2.6888 1.6181z" fill="#a32e24"/><path fill-rule="evenodd" clip-rule="evenodd" d="M13.4454 3.58723V10.1887L10.8697 8.49344 10.9293 1.79873l2.5161 1.7885z" fill="#a32e24"/><path d="M16.0599 1.79873 13.4454.13981 10.9293 1.79873l2.5161 1.7885 2.6145-1.7885z" fill="#ee958a"/><path d="M16.06 1.79876 16.0793 5.52165 16.1123 11.8484V18.467l2.5766-1.6518V13.4696 10.124 6.86126l7.8033 4.96754V8.52025L16.06 1.79876z" fill="#e5ad11"/><path d="M18.6889 16.8152 16.1123 18.467l10.3682 6.7159V21.8372l-7.7916-5.022z" fill="#e5ad11"/><path d="M26.4805 15.1751 18.6889 10.124v3.3456l2.7505 1.7641 5.0411 3.2333V15.1751z" fill="#e5ad11"/><path d="M29.1068 13.5067l-2.6263 1.6684V18.467l2.6263-1.6518V13.5067z" fill="#d48041"/><path d="M29.1185 20.0851l-2.638 1.7521v3.3457l2.6263-1.6897L29.1185 20.0851z" fill="#d48041"/><path fill-rule="evenodd" clip-rule="evenodd" d="M26.4805 21.8372l-7.7916-5.022 2.7505-1.5815 5.0411 3.2333 2.638 1.6181-2.638 1.7521z" fill="#efcf6f"/><path d="M18.6889 13.4696v3.3456l2.7505-1.5815-2.7505-1.7641z" fill="#d48041"/><path d="M20.1621 26.5165l-4.2015-2.7017-4.2015-2.7016L11.7108 23.8491l6.3384 4.0776 2.1129 1.3512V26.5165z" fill="#395aad"/><path d="M7.49852 23.8491v2.6674l8.41958 5.4439V29.2779L7.49852 23.8491z" fill="#276e3a"/><path d="M9.57951 22.4781l-2.08099 1.371 8.41958 5.4288 2.1311-1.3512-6.3384-4.0776-2.13129-1.371z" fill="#add284"/><path d="M24.3747 26.5165V23.8491L22.174 22.8377l-2.0054.9665 2.1815 1.3793 2.0246 1.333z" fill="#395aad"/><path d="M18.0492 19.7061l2.1194 1.431-2.048 1.3721-2.1698-1.3721 2.0984-1.431z" fill="#395aad"/><path fill-rule="evenodd" clip-rule="evenodd" d="M20.1621 18.4432l-2.0415-.596-2.1581.596-2.1017 1.3349-2.1017 1.3351 2.1012 1.3511 6.3018 4.0522 2.188-1.333-2.1815-1.3793 2.0054-.9665 2.2007 1.0114 2.0995-1.329-2.0811-1.4069L22.3501 21.1371l-.1752-1.4237L22.174 19.7061l-2.0119-1.2629zm-2.1129 1.2629 2.1194 1.431-2.048 1.3721-2.1698-1.3721 2.0984-1.431z" fill="#9ec4e0"/><path d="M26.4742 22.5201l-2.0995 1.329v2.6674l2.1289-1.3305L26.4742 22.5201z" fill="#4285f4"/><path d="M20.1621 26.5165v2.7614l2.188-1.3512V25.1835l-2.188 1.333z" fill="#4285f4"/><path d="M15.9181 29.2779v2.6825l2.1311-1.3708V27.9267l-2.1311 1.3512z" fill="#4e9c68"/></svg></span><span class=navbar-brand__name>HEIR</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class="nav-link active" href=/><span>Home</span></a></li><li class=nav-item><a class="nav-link active" href=/docs/><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/community/><span>Community</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/google/heir/ target=_blank rel=noopener><span>GitHub</span></a></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m--li><a href=/ title="HEIR: Homomorphic Encryption Intermediate Representation" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-><span>Home</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ title=Documentation class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docs><span>Docs</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting_started-li><a href=/docs/getting_started/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsgetting_started><span>Getting Started</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsdevelopment-li><a href=/docs/development/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsdevelopment><span>Development</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdevelopmentbazel-li><a href=/docs/development/bazel/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentbazel><span>Bazel tips</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdevelopmentboilerplate-li><a href=/docs/development/boilerplate/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentboilerplate><span>Boilerplate tools</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdevelopmentide-li><a href=/docs/development/ide/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentide><span>IDE configuration</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorials-li><a href=/docs/tutorials/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorials><span>Tutorials and Talks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsresearch_with_heir-li><a href=/docs/research_with_heir/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsresearch_with_heir><span>Research with HEIR</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsdesign-li><a href=/docs/design/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsdesign><span>Design</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsdesignmanagement-li><a href=/docs/design/management/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docsdesignmanagement><span class=td-sidebar-nav-active-item>Ciphertext Management</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignlayout-li><a href=/docs/design/layout/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignlayout><span>Ciphertext Packing System</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesigndo_transformation-li><a href=/docs/design/do_transformation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesigndo_transformation><span>Data-oblivious Transformations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignnoise-li><a href=/docs/design/noise/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignnoise><span>Noise Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignsecret-li><a href=/docs/design/secret/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignsecret><span>Secret</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignsimd-li><a href=/docs/design/simd/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignsimd><span>SIMD Optimizations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignrelinearization_ilp-li><a href=/docs/design/relinearization_ilp/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignrelinearization_ilp><span>Optimizing relinearization</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docspipelines-li><a href=/docs/pipelines/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspipelines><span>Pipelines</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsdialects-li><a href=/docs/dialects/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsdialects><span>Dialects</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsbgv-li><a href=/docs/dialects/bgv/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsbgv><span>BGV</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectscggi-li><a href=/docs/dialects/cggi/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectscggi><span>CGGI</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsckks-li><a href=/docs/dialects/ckks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsckks><span>CKKS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectscomb-li><a href=/docs/dialects/comb/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectscomb><span>Comb</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsjaxite-li><a href=/docs/dialects/jaxite/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsjaxite><span>Jaxite</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsjaxiteword-li><a href=/docs/dialects/jaxiteword/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsjaxiteword><span>JaxiteWord</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectslattigo-li><a href=/docs/dialects/lattigo/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectslattigo><span>Lattigo</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectslwe-li><a href=/docs/dialects/lwe/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectslwe><span>LWE</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsmathext-li><a href=/docs/dialects/mathext/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsmathext><span>MathExt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsmgmt-li><a href=/docs/dialects/mgmt/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsmgmt><span>Mgmt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsmodarith-li><a href=/docs/dialects/modarith/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsmodarith><span>ModArith</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsopenfhe-li><a href=/docs/dialects/openfhe/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsopenfhe><span>Openfhe</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectspolynomial-li><a href=/docs/dialects/polynomial/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectspolynomial><span>Polynomial</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsrandom-li><a href=/docs/dialects/random/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsrandom><span>Random</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsrns-li><a href=/docs/dialects/rns/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsrns><span>RNS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectssecret-li><a href=/docs/dialects/secret/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectssecret><span>Secret</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstensorext-li><a href=/docs/dialects/tensorext/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstensorext><span>TensorExt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstfherust-li><a href=/docs/dialects/tfherust/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstfherust><span>TfheRust</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstfherustbool-li><a href=/docs/dialects/tfherustbool/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstfherustbool><span>TfheRustBool</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docspasses-li><a href=/docs/passes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspasses><span>Passes</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-community-li><a href=/community/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-community><span>Community</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-search-li><a href=/search/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-search><span>Search Results</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a id=print href=https://heir.dev/docs/design/_print/><i class="fa-solid fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#bgv>BGV</a><ul><li><a href=#bgv-relinearization>BGV: Relinearization</a></li><li><a href=#bgv-modulus-switching>BGV: Modulus switching</a></li><li><a href=#bgv-scale-management>BGV: Scale management</a></li><li><a href=#bgv-cross-level-operation>BGV: Cross Level Operation</a></li><li><a href=#bgv-implementation-in-heir>BGV: Implementation in HEIR</a></li></ul></li><li><a href=#ckks>CKKS</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://heir.dev/docs/>Docs</a></li><li class=breadcrumb-item><a href=https://heir.dev/docs/design/>Design</a></li><li class="breadcrumb-item active" aria-current=page>Ciphertext Management</li></ol></nav><div class=td-content><h1>Ciphertext Management</h1><header class=article-meta></header><p>On 2025-04-17, Hongren Zheng gave a talk overview of the ciphertext management
system in the HEIR working group meeting.
<a href="https://youtu.be/HHU6rCMxZRc?si=U_ePY5emqs6e4NoV&amp;t=1631">The video can be found here</a>
and <a href=/slides/mgmt-2025-04-17.pdf>the slides can be found here</a></p><h2 id=introduction>Introduction</h2><p>To lower from user specified computation to FHE scheme operations, a compiler
must insert <em>ciphertext management</em> operations to satisfy various requirements
of the FHE scheme, like modulus switching, relinearization, and bootstrapping.
In HEIR, such operations are modeled in a scheme-agnostic way in the <code>mgmt</code>
dialect.</p><p>Taking the arithmetic pipeline as example: a program specified in high-level
MLIR dialects like <code>arith</code> and <code>linalg</code> is first transformed to an IR with only
<code>arith.addi/addf</code>, <code>arith.muli/mulf</code>, and <code>tensor_ext.rotate</code> operations. We
call this form the <em>secret arithmetic</em> IR.</p><p>Then management passes insert <code>mgmt</code> ops to support future lowerings to scheme
dialects like <code>bgv</code> and <code>ckks</code>. As different schemes have different management
requirement, they should be inserted in different styles.</p><p>We discuss each scheme below to show the design in HEIR. For RLWE schemes, we
all assume RNS instantiation.</p><h2 id=bgv>BGV</h2><p>BGV is a leveled scheme where each level has a modulus $q_i$. The level is
numbered from $0$ to $L$ where $L$ is the input level and $0$ is the output
level. The core feature of BGV is that when the magnititude of the noise becomes
large (often caused by multiplication), a modulus switching operation from level
$i$ to level $i-1$ can be inserted to reduce the noise to a &ldquo;constant&rdquo; level. In
this way, BGV can support a circuit of multiplicative depth $L$.</p><h3 id=bgv-relinearization>BGV: Relinearization</h3><p>HEIR initially inserts relinearization ops immediately after each multiplication
to keep ciphertext dimension &ldquo;linear&rdquo;. A later relinearization optimization pass
relaxes this requirement, and uses an integer linear program to decide when to
relinearize. See <a href=/docs/design/relinearization_ilp/>Optimizing Relinearization</a>
for more details.</p><h3 id=bgv-modulus-switching>BGV: Modulus switching</h3><p>There are several techniques to insert modulus switching ops.</p><p>For the example circuit <code>input -> mult -> mult -> output</code>, the insertion result
could be one of</p><ol><li><p>After multiplication: <code>input -> (mult -> ms) -> (mult -> ms) -> output</code></p></li><li><p>Before multiplication: <code>input -> (mult) -> (ms -> mult) -> (ms -> output)</code></p></li><li><p>Before multiplication (including the first multiplication):
<code>input -> (ms -> mult) -> (ms -> mult) -> (ms -> output)</code></p></li></ol><p>The first strategy is from the BGV paper, the second and third strategies are
from OpenFHE, which correspond to the <code>FLEXIBLEAUTO</code> mode and <code>FLEXIBLEAUTOEXT</code>
mode, respectively.</p><p>The first strategy is conceptually simpler, yet other policies have the
advantage of smaller noise growth. In latter policies, by delaying the modulus
switch until just before multiplication, the noise from other operations between
multiplications (like rotation/relinearization) also benefit from the noise
reduction of a modulus switch.</p><p>Note that, as multiplication has two operands, the actual circuit for the latter
two policies is <code>mult(ms(ct0), ms(ct1))</code>, whereas in the first policy the
circuit is <code>ms(mult(ct0, ct1))</code>.</p><p>The third policy has one more switching op than the others, so it will need one
more modulus.</p><p>There are also other insertion strategy like inserting it dynamically based on
current noise (see HElib) or lazy modulus switching. Those are not implemented.</p><h3 id=bgv-scale-management>BGV: Scale management</h3><p>For the original BGV scheme, it is required to have $qi \equiv 1 \pmod{t}$
where $t$ is the plaintext modulus. However in practice such requirement will
make the choice of $q_i$ too constrained. In the GHS variant, this condition is
removed, with the price of scale management needed.</p><p>Modulus switching from level $i$ to level $i-1$ is essentially dividing (with
rounding) the ciphertext by $q_i$, hence dividing the noise and payload message
inside by $q_i$. The message $m$ can often be written as $[m]_t$, the coset
representative of <code>m</code> $\mathbb{Z}/t\mathbb{Z}$. Then by dividing of $q_i$
produces a result message $[m \cdot q_i^{-1}]_t$.</p><p>Note that when $qi \equiv 1 \pmod{t}$, the result message is the same as the
original message. However, in the GHS variant this does not always hold, so we
call the introduced factor of $[q^{-1}]_t$ the <em>scale</em> of the message. HEIR
needs to record and manage it during compilation. When decrypting the scale must
be removed to obtain the right message.</p><p>Note that, for messages $m_0$ and $m_1$ of different scale $a$ and $b$, we
cannot add them directly because $[a \cdot m_0 + b \cdot m_1]_t$ does not
always equal $[m_0 + m_1]_t$. Instead we need to adjust the scale of one
message to match the other, so $[b \cdot m_0 + b \cdot m_1]_t = [b \cdot
(m_0 + m_1)]_t$. Such adjustment could be done by multiplying $m_0$ with a
constant $[b \cdot a^{-1}]_t$. This adjustment is not for free, and
increases the ciphertext noise.</p><p>As one may expect, different modulus switching insertion strategies affect
message scale differently. For $m_0$ with scale $a$ and $m_1$ with scale $b$,
the result scale would be</p><ol><li><p>After multiplication: $[ab / qi]_t$.</p></li><li><p>Before multiplication: $[a / qi \cdot b / qi]_t = [ab / (qi^2)]_t$.</p></li></ol><p>This is messy enough. To ease the burden, we can impose additional requirement:
mandate a constant scale $\Delta_i$ for all ciphertext at level $i$. This is
called the <em>level-specific scaling factor</em>. With this in mind, addition within
one level can happen without caring about the scale.</p><ol><li><p>After multiplication: $\Delta_{i-1} = [\Delta_i^2 / qi]_t$</p></li><li><p>Before multiplication: $\Delta_{i-1} = [\Delta_i^2 / (qi^2)]_t$</p></li></ol><h3 id=bgv-cross-level-operation>BGV: Cross Level Operation</h3><p>With the level-specific scaling factor, one may wonder how to perform addition
and multiplication of ciphertexts on different levels. This can be done by
adjusting the level and scale of the ciphertext at the higher level.</p><p>The level can be easily adjusted by dropping the extra limbs, and scale can be
adjusted by multiplying a constant, but because multiplying a constant will
incur additional noise, the procedure becomes the following:</p><ol><li><p>Assume the level and scale of two ciphertexts are $l_1$ and $l_2$, $s_1$ and
$s_2$ respectively. WLOG assume $l_1 > l_2$.</p></li><li><p>Drop $l_1 - l_2 - 1$ limbs for the first ciphertext to make it at level $l_2
+ 1$, if those extra limbs exist.</p></li><li><p>Adjust scale from $s_1$ to $s_2 \cdot q_{l_2 + 1}$ by multiplying $[s_2
\cdot q_{l_2 + 1} / s1]_t$ for the first ciphertext.</p></li><li><p>Modulus switch from $l_2 + 1$ to $l_2$, producing scale $s_2$ for the first
ciphertext and its noise is controlled.</p></li></ol><h3 id=bgv-implementation-in-heir>BGV: Implementation in HEIR</h3><p>In HEIR the different modulus switching policy is controlled by the pass option
for <code>--secret-insert-mgmt-bgv</code>. The pass defaults to the &ldquo;Before Multiplication&rdquo;
policy. If user wants other policy, the <code>after-mul</code> or
<code>before-mul-include-first-mul</code> option may be used. The <code>mlir-to-bgv</code> pipeline
option <code>modulus-switch-before-first-mul</code> corresponds to the latter option.</p><p>The <code>secret-insert-mgmt</code> pass is also responsible for managing cross-level
operations. However, as the scheme parameters are not generated at this point,
the concrete scale could not be instantiated so some placeholder operations are
inserted.</p><p>After the modulus switching policy is applied, the <code>generate-param-bgv</code> pass
generates scheme parameters. Optionally, user could skip this pass by manually
providing scheme parameter as an attribute at module level.</p><p>Then <code>populate-scale-bgv</code> comes into play by using the scheme parameters to
instantiate concrete scale, and turn those placeholder operations into concrete
multiplication operation.</p><h2 id=ckks>CKKS</h2><p>CKKS is a leveled scheme where each level has a modulus $q_i$. The level is
numbered from $0$ to $L$ where $L$ is the input level and $0$ is the output
level. CKKS ciphertext contains a scaled message $\Delta m$ where $\Delta$
takes some value like $2^40$ or $2^80$. After multiplication of two messages,
the scaling factor $\Delta&rsquo;$ will become larger, hence some kind of management
policy is needed in case it blows up. Contrary to BGV where modulus switching is
used for noise management, in CKKS modulus switching from level $i$ to level
$i-1$ can divide the scaling factor $\Delta$ by the modulus $q_i$.</p><p>The management of CKKS is similar to BGV above in the sense that their strategy
are the similar and uses similar code base. However, BGV scale management is
internal and users are not required to concern about it, while CKKS scale
management is visible to user as it affects the precision. One notable
difference is that, for &ldquo;Before multiplication (including the first
multiplication)&rdquo; modulus switching policy, the user input should be encoded at
$\Delta^2$ or higher, as otherwise the first modulus switching (or rescaling in
CKKS term) will rescale $\Delta$ to $1$, rendering full precision loss.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/google/heir aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2025 The HEIR Authors All Rights Reserved</span>
<span class=ms-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.027d75d71824837bee74c12a7806c5fe51249c1ca7accc27553a251a75cdb3a4.js integrity="sha256-An111xgkg3vudMEqeAbF/lEknBynrMwnVTolGnXNs6Q=" crossorigin=anonymous></script>
<script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>