<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.113.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>SIMD Optimizations | HEIR</title><meta name=description content="HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE schemes support (also commonly known as &amp;ldquo;packing&amp;rdquo; or &amp;ldquo;batching&amp;rdquo;). Specifically, HEIR incorporates the &amp;ldquo;automated batching&amp;rdquo; optimizations (among many other things) from the HECO compiler. The following will assume basic familiarity with the FHE SIMD paradigm and the high-level goals of the optimization, and we refer to the associated HECO paper, slides, talk and additional resources on the Usenix'23 website for an introduction to the topic."><meta property="og:title" content="SIMD Optimizations"><meta property="og:description" content="HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE schemes support (also commonly known as &ldquo;packing&rdquo; or &ldquo;batching&rdquo;). Specifically, HEIR incorporates the &ldquo;automated batching&rdquo; optimizations (among many other things) from the HECO compiler. The following will assume basic familiarity with the FHE SIMD paradigm and the high-level goals of the optimization, and we refer to the associated HECO paper, slides, talk and additional resources on the Usenix'23 website for an introduction to the topic."><meta property="og:type" content="article"><meta property="og:url" content="https://heir.dev/docs/design/simd/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-06-06T09:33:00+00:00"><meta itemprop=name content="SIMD Optimizations"><meta itemprop=description content="HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE schemes support (also commonly known as &ldquo;packing&rdquo; or &ldquo;batching&rdquo;). Specifically, HEIR incorporates the &ldquo;automated batching&rdquo; optimizations (among many other things) from the HECO compiler. The following will assume basic familiarity with the FHE SIMD paradigm and the high-level goals of the optimization, and we refer to the associated HECO paper, slides, talk and additional resources on the Usenix'23 website for an introduction to the topic."><meta itemprop=dateModified content="2024-06-06T09:33:00+00:00"><meta itemprop=wordCount content="1819"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="SIMD Optimizations"><meta name=twitter:description content="HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE schemes support (also commonly known as &ldquo;packing&rdquo; or &ldquo;batching&rdquo;). Specifically, HEIR incorporates the &ldquo;automated batching&rdquo; optimizations (among many other things) from the HECO compiler. The following will assume basic familiarity with the FHE SIMD paradigm and the high-level goals of the optimization, and we refer to the associated HECO paper, slides, talk and additional resources on the Usenix'23 website for an introduction to the topic."><link rel=preload href=/scss/main.min.dffc1689fd83830a5fb090d38ca9680587c322008ad97c675ee0ca22e5fb10d5.css as=style><link href=/scss/main.min.dffc1689fd83830a5fb090d38ca9680587c322008ad97c675ee0ca22e5fb10d5.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script>
<script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body class=td-page><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=navbar-brand__name>HEIR</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class="nav-link active" href=/><span>Home</span></a></li><li class=nav-item><a class="nav-link active" href=/docs/><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/community/><span>Community</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/google/heir/ target=_blank rel=noopener><span>GitHub</span></a></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m--li><a href=/ title="HEIR: Homomorphic Encryption Intermediate Representation" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-><span>Home</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ title=Documentation class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docs><span>Docs</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributing-li><a href=/docs/contributing/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributing><span>Contributing to HEIR</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docside_configuration-li><a href=/docs/ide_configuration/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docside_configuration><span>IDE Configuration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsdialects-li><a href=/docs/dialects/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsdialects><span>Dialects</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsarithext-li><a href=/docs/dialects/arithext/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsarithext><span>ArithExt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsbgv-li><a href=/docs/dialects/bgv/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsbgv><span>BGV</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectscggi-li><a href=/docs/dialects/cggi/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectscggi><span>CGGI</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectscomb-li><a href=/docs/dialects/comb/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectscomb><span>Comb</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsjaxite-li><a href=/docs/dialects/jaxite/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsjaxite><span>Jaxite</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectslwe-li><a href=/docs/dialects/lwe/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectslwe><span>LWE</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsopenfhe-li><a href=/docs/dialects/openfhe/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsopenfhe><span>Openfhe</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectspolyext-li><a href=/docs/dialects/polyext/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectspolyext><span>PolyExt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectspolynomial-li><a href=/docs/dialects/polynomial/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectspolynomial><span>Polynomial</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsrns-li><a href=/docs/dialects/rns/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsrns><span>RNS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectssecret-li><a href=/docs/dialects/secret/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectssecret><span>Secret</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstensorext-li><a href=/docs/dialects/tensorext/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstensorext><span>TensorExt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstfherust-li><a href=/docs/dialects/tfherust/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstfherust><span>TfheRust</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstfherustbool-li><a href=/docs/dialects/tfherustbool/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstfherustbool><span>TfheRustBool</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docspasses-li><a href=/docs/passes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docspasses><span>Passes</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesapplyfolderspasses-li><a href=/docs/passes/applyfolderspasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesapplyfolderspasses><span>ApplyFoldersPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesbgvpasses-li><a href=/docs/passes/bgvpasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesbgvpasses><span>BGVPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesbgvtoopenfhe-li><a href=/docs/passes/bgvtoopenfhe/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesbgvtoopenfhe><span>BGVToOpenfhe</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesbgvtopolynomial-li><a href=/docs/passes/bgvtopolynomial/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesbgvtopolynomial><span>BGVToPolynomial</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassescggipasses-li><a href=/docs/passes/cggipasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassescggipasses><span>CGGIPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassescggitotfherust-li><a href=/docs/passes/cggitotfherust/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassescggitotfherust><span>CGGIToTfheRust</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassescggitotfherustbool-li><a href=/docs/passes/cggitotfherustbool/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassescggitotfherustbool><span>CGGIToTfheRustBool</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassescombtocggi-li><a href=/docs/passes/combtocggi/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassescombtocggi><span>CombToCGGI</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesconvertiftoselectpasses-li><a href=/docs/passes/convertiftoselectpasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesconvertiftoselectpasses><span>ConvertIfToSelectPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspasseselementwisetoaffinepasses-li><a href=/docs/passes/elementwisetoaffinepasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspasseselementwisetoaffinepasses><span>ElementwiseToAffinePasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesforwardstoretoloadpasses-li><a href=/docs/passes/forwardstoretoloadpasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesforwardstoretoloadpasses><span>ForwardStoreToLoadPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesfullloopunrollpasses-li><a href=/docs/passes/fullloopunrollpasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesfullloopunrollpasses><span>FullLoopUnrollPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspasseslwepasses-li><a href=/docs/passes/lwepasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspasseslwepasses><span>LWEPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesmemreftoarith-li><a href=/docs/passes/memreftoarith/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesmemreftoarith><span>MemrefToArith</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesopenfhepasses-li><a href=/docs/passes/openfhepasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesopenfhepasses><span>OpenfhePasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassespolynomialpasses-li><a href=/docs/passes/polynomialpasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassespolynomialpasses><span>PolynomialPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassespolynomialtostandard-li><a href=/docs/passes/polynomialtostandard/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassespolynomialtostandard><span>PolynomialToStandard</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassessecretizepasses-li><a href=/docs/passes/secretizepasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassessecretizepasses><span>SecretizePasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassessecretpasses-li><a href=/docs/passes/secretpasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassessecretpasses><span>SecretPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassessecrettobgv-li><a href=/docs/passes/secrettobgv/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassessecrettobgv><span>SecretToBGV</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesstraightlinevectorizerpasses-li><a href=/docs/passes/straightlinevectorizerpasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesstraightlinevectorizerpasses><span>StraightLineVectorizerPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassestensorextpasses-li><a href=/docs/passes/tensorextpasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassestensorextpasses><span>TensorExtPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesunusedmemrefpasses-li><a href=/docs/passes/unusedmemrefpasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesunusedmemrefpasses><span>UnusedMemRefPasses</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docspassesyosysoptimizerpasses-li><a href=/docs/passes/yosysoptimizerpasses/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspassesyosysoptimizerpasses><span>YosysOptimizerPasses</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsdesign-li><a href=/docs/design/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsdesign><span>Design</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignsecret-li><a href=/docs/design/secret/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignsecret><span>Secret</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsdesignsimd-li><a href=/docs/design/simd/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docsdesignsimd><span class=td-sidebar-nav-active-item>SIMD Optimizations</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docspipelines-li><a href=/docs/pipelines/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspipelines><span>Pipelines</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorials-li><a href=/docs/tutorials/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorials><span>Tutorials and Talks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting_started-li><a href=/docs/getting_started/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsgetting_started><span>Getting Started</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-community-li><a href=/community/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-community><span>Community</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-search-li><a href=/search/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-search><span>Search Results</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/google/heir/tree/main/docs/content/en/docs/Design/simd.md class=td-page-meta--view target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/google/heir/edit/main/docs/content/en/docs/Design/simd.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/google/heir/new/main/docs/content/en/docs/Design/simd.md?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/google/heir/issues/new?title=SIMD%20Optimizations" class=td-page-meta--issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
<a id=print href=https://heir.dev/docs/design/_print/><i class="fa-solid fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#representing-fhe-simd-operations>Representing FHE SIMD Operations</a></li><li><a href=#intended-usage>Intended Usage</a></li><li><a href=#implementation>Implementation</a><ul><li><a href=#components>Components</a></li><li><a href=#high-level-flow>High-Level Flow</a></li><li><a href=#insert-rotate-pass>Insert Rotate Pass</a></li><li><a href=#tensorext-canonicalization>TensorExt Canonicalization</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://heir.dev/docs/>Docs</a></li><li class=breadcrumb-item><a href=https://heir.dev/docs/design/>Design</a></li><li class="breadcrumb-item active" aria-current=page>SIMD Optimizations</li></ol></nav><div class=td-content><h1>SIMD Optimizations</h1><header class=article-meta></header><p>HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE schemes support (also commonly known as &ldquo;packing&rdquo; or &ldquo;batching&rdquo;).
Specifically, HEIR incorporates the &ldquo;automated batching&rdquo; optimizations (among many other things) from the <a href=https://github.com/MarbleHE/HECO>HECO</a> compiler.
The following will assume basic familiarity with the FHE SIMD paradigm and the high-level goals of the optimization, and we refer to the associated HECO <a href=https://www.usenix.org/system/files/usenixsecurity23-viand.pdf>paper</a>, <a href=https://www.usenix.org/system/files/sec23_slides_viand.pdf>slides</a>, <a href="https://www.youtube.com/watch?v=SP3C6gLWIS4">talk</a> and additional resources on the <a href=https://www.usenix.org/conference/usenixsecurity23/presentation/viand>Usenix'23 website</a> for an introduction to the topic.
This documentation will mostly focus on describing how the optimization is realized in HEIR (which differs somewhat from the original implementation) and how the optimization is intended to be used in an overall end-to-end compilation pipeline.</p><h2 id=representing-fhe-simd-operations>Representing FHE SIMD Operations</h2><p>Following the design principle of maintaining programs in standard MLIR dialects as long as possible (cf. the design rationale behind the <a href=https://heir.dev/docs/design/secret/>Secret Dialect</a>),
HEIR uses the MLIR <a href=https://mlir.llvm.org/docs/Dialects/TensorOps/><code>tensor</code> dialect</a> and <a href=https://mlir.llvm.org/docs/Traits/#elementwisemappable>ElementwiseMappable</a> operations from the MLIR <a href=https://mlir.llvm.org/docs/Dialects/ArithOps/><code>arith</code> dialect</a> to represent HE SIMD operations.</p><p>We do introduce the HEIR-specific <a href=https://heir.dev/docs/dialects/tensorext/#tensor_extrotate-heirtensor_extrotateop><code>tensor_ext.rotate</code></a> operation, which represents a cyclical left-rotation of a tensor.
Note that, as the current SIMD vectorizer only supports one-dimensional tensors, the semantics of this operation on multi-dimensional tensors are not (currently) defined.</p><p>For example, the common &ldquo;rotate-and-reduce&rdquo; pattern which results in each element containing the sum/product/etc of the original vector can be expressed as:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%tensor</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>from_elements</span> <span style=color:#000>%i1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i6</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i8</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c4</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%0</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%4</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>The <code>%cN</code> and <code>%iN</code>, which are defined as <code>%cN = arith.constant N : index</code> and <code>%iN = arith.constant N : i16</code>, respectively, have been omitted for readability.</p><h2 id=intended-usage>Intended Usage</h2><p>The <code>-heir-simd-vectorizer</code> pipeline transforms a program consisting of loops and index-based accesses into tensors (e.g., <code>tensor.extract</code> and <code>tensor.insert</code>) into one consisting of SIMD operations (including rotations) on entire tensors.
While its implementation does not depend on any FHE-specific details or even the Secret dialect, this transformation is likely only useful when lowering a high-level program to an arithmetic-circuit-based FHE scheme (e.g., B/FV, BGV, or CKKS).
The <code>-mlir-to-openfhe-bgv</code> pipeline demonstrates the intended flow: augmenting a high-level program with <code>secret</code> annotations, then applying the SIMD optimization (and any other high-level optimizations) before lowering to BGV operations and then exiting to OpenFHE.</p><blockquote><p><strong>Warning</strong>
The current SIMD vectorizer pipeline supports only one-dimensional tensors.
As a workaround, one could reshape all multi-dimensional tensors into one-dimensional tensors, but MLIR/HEIR currently do not provide a pass to automate this process.</p></blockquote><p>Since the optimization is based on heuristics, the resulting program might not be optimal or could even be worse than a trivial realization that does not use ciphertext packing.
However, well-structured programs generally lower to reasonable batched solutions, even if they do not achieve optimal batching layouts.
For common operations such as matrix-vector or matrix-matrix multiplications, state-of-the-art approaches require advanced packing schemes that might map elements into the ciphertext vector in non-trivial ways (e.g., diagonal-major and/or replicated).
The current SIMD vectorizer will never change the arrangement of elements inside an input tensor and therefore cannot produce the optimal approaches for these operations.</p><p>Note, that the SIMD batching optimization is different from, and significantly more complex than, the Straight Line Vectorizer (<code>-straight-line-vectorize</code> pass), which simply groups <a href=https://mlir.llvm.org/docs/Traits/#elementwisemappable>ElementwiseMappable</a> operations that agree in operation name and operand/result types into vectorized/tensorized versions.</p><h2 id=implementation>Implementation</h2><p>Below, we give a brief overview over the implementation, with the goal of
both improving maintainability/extensibility of the SIMD vectorizer and allowing advanced users to better understand why a certain program is transformed in the way it is.</p><h3 id=components>Components</h3><p>The <code>-heir-simd-vectorizer</code> pipeline uses a combination of standard MLIR passes (<a href=https://mlir.llvm.org/docs/Passes/#-canonicalize><code>-canonicalize</code></a>, <a href=https://mlir.llvm.org/docs/Passes/#-cse><code>-cse</code></a>, <a href=https://mlir.llvm.org/docs/Passes/#-sccp><code>-sccp</code></a>) and custom HEIR passes.
Some of these (<a href=https://heir.dev/docs/passes/applyfolderspasses/#-apply-folders><code>-apply-folders</code></a>, <a href=https://heir.dev/docs/passes/fullloopunrollpasses/#-full-loop-unroll><code>-full-loop-unroll</code></a>) might have applications outside the SIMD optimization, while others (<a href=https://heir.dev/docs/passes/tensorextpasses/#-insert-rotate><code>-insert-rotate</code></a>, <a href=https://heir.dev/docs/passes/tensorextpasses/#-collapse-insertion-chains><code>-collapse-insertion-chains</code></a> and <a href=https://heir.dev/docs/passes/tensorextpasses/#-rotate-and-reduce><code>-rotate-and-reduce</code></a>) are very specific to the FHE SIMD optimization.
In addition, the passes make use of the <code>RotationAnalysis</code> and <code>TargetSlotAnalysis</code> analyses.</p><h3 id=high-level-flow>High-Level Flow</h3><ul><li><p><strong>Loop Unrolling</strong> (<code>-full-loop-unroll</code>):
The implementation currently begins by unrolling all loops in the program to simplify the later passes.
See <a href=https://github.com/google/heir/issues/589>#589</a> for a discussion on how this could be avoided.</p></li><li><p><strong>Canonicalization</strong> (<code>-apply-folders -canonicalize</code>):
As the rotation-specific passes are very strict about the structure of the IR they operate on, we must first simplify away things such as tensors of constant values.
For performance reasons (c.f. comments in the <code>heirSIMDVectorizerPipelineBuilder</code> function in <code>heir-opt.cpp</code>), this must be done by first applying <a href=https://mlir.llvm.org/docs/Canonicalization/#canonicalizing-with-the-fold-method>folds</a> before applying the full <a href=https://mlir.llvm.org/docs/Canonicalization/>canonicalization</a>.</p></li><li><p><strong>Main SIMD Rewrite</strong> (<code>-insert-rotate -cse -canonicalize -cse</code>):
This pass rewrites arithmetic operations over <code>tensor.extract</code>-ed operands into SIMD operations over the entire tensor, rotating the (full-tensor) operands so that the correct elements interact.
For example, it will rewrite the following snippet (which computes <code>t2[4] = t0[3] + t1[5]</code>)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>extract</span> <span style=color:#000>%t0</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c3</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>extract</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c5</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span> <span style=color:#a40000>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>insert</span> <span style=color:#000>%2</span> <span style=color:#a40000>in</span><span style=color:#204a87;font-weight:700>to</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%t0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c31</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>i.e., rotating <code>t0</code> down by one (31 = -1 (mod 32)) and <code>t1</code> up by one to bring the elements at index 3 and 5, respectively, to the &ldquo;target&rdquo; index 4.
The pass uses the <code>TargetSlotAnalysis</code> to identify the appropriate target index (or ciphertext &ldquo;slot&rdquo; in FHE-speak).
See <a href=#insert-rotate-pass>Insert Rotate Pass</a> below for more details. This pass is roughly equivalent to the <code>-batching</code> pass in the original HECO implementation.</p><p>Doing this rewrite by itself does not represent an optimization, but if we consider what happens to the corresponding code for other indices (e.g., <code>t2[5] = t0[4] + t1[6]</code>), we see that the pass transforms expressions with the same relative index offsets into the exact same set of rotations/SIMD operations, so the following <a href=https://en.wikipedia.org/wiki/Common_subexpression_elimination>Common Subexpression Elimination (CSE)</a> will remove redundant computations.
We apply CSE twice, once directly (which creates new opportunities for canonicalization and folding) and then again after that canonicalization.
See <a href=#tensorext-canonicalization>TensorExt Canonicalization</a> for a description of the rotation-specific canonocalization patterns).</p></li><li><p><strong>Cleanup of Redundant Insert/Extract</strong> (<code>-collapse-insertion-chains -sccp -canonicalize -cse</code>):
Because the <code>-insert-rotate</code> pass maintains the consistency of the IR, it emits a <code>tensor.extract</code> operation after the SIMD operation and uses that to replace the original operation (which is valid, as both produce the desired scalar result).
As a consequence, the generated code for the snippet above is actually trailed by a (redundant) extract/insert:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>extract</span> <span style=color:#000>%2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%inserted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>insert</span> <span style=color:#000>%extracted</span> <span style=color:#a40000>in</span><span style=color:#204a87;font-weight:700>to</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>In real code, this might generate a long series of such extraction/insertion operations, all extracting from the same (due to CSE) tensor and inserting into the same output tensor. Therefore, the <code>-collapse-insertion-chains</code> pass searches for such chains over entire tensors and collapses them.
It supports not just chains where the indices match perfectly, but any chain where the relative offset is consistent across the tensor, issuing a rotation to realize the offset (if the offset is zero, the canonicalization will remove the redundant rotation).
Note, that in HECO, insertion/extraction is handled differently, as HECO features a <code>combine</code> operation modelling not just simple insertions (<code>combine(%t0#j, %t1)</code>) but also more complex operations over slices of tensors (<code>combine(%t0#[i,j], %t1)</code>).
As a result, the equivalent pass in HECO (<code>-combine-simplify</code>) instead joins different <code>combine</code> operations, and a later fold removes <code>combines</code> that replace the entire target tensor.
See issue <a href=https://github.com/google/heir/issues/512>#512</a> for a discussion on why the <code>combine</code> operation is a more powerful framework and what would be necessary to port it to HEIR.</p></li><li><p><strong>Applying Rotate-and-Reduce Patterns</strong> (<code>-rotate-and-reduce -sccp -canonicalize -cse</code>):
The rotate and reduce pattern (see <a href=#representing-fhe-simd-operations>Representing FHE SIMD Operations</a> for an example) is an important aspect of accelerating SIMD-style operations in FHE, but it does not follow automatically from the batching rewrites applied so far.
As a result, the <code>-rotate-and-reduce</code> pass needs to search for sequences of arithmetic operations that correspond to the full folding of a tensor,
i.e., patterns such as <code>t[0]+(t[1]+(t[2]+t[3]+(...)))</code>, which currently uses a backwards search through the IR, but could be achieved more efficiently through a data flow analysis (c.f. issue <a href=https://github.com/google/heir/issues/523>#532</a>).
In HECO, rotate-and-reduce is handled differently, by identifying sequences of compatible operations prior to batching and rewriting them to &ldquo;n-ary&rdquo; operations.
However, this approach requires non-standard arithmetic operations and is therefore not suitable for use in HEIR.
However, there is likely still an opportunity to make the patterns in HEIR more robust/general (e.g., support constant scalar operands in the fold, or support non-full-tensor folds).
See issue <a href=https://github.com/google/heir/issues/522>#522</a> for ideas on how to make the HEIR pattern more robust/more general.</p></li></ul><h3 id=insert-rotate-pass>Insert Rotate Pass</h3><p>TODO(#721): Write a detailed description of the rotation insertion pass and the associated target slot analysis.</p><h3 id=tensorext-canonicalization>TensorExt Canonicalization</h3><p>The <a href=https://heir.dev/docs/dialects/tensorext/>TensorExt (<code>tensor_ext</code>) Dialect</a> includes a series of canonicalization rules that are essential to making automatically generated rotation code efficient:</p><ul><li><p>Rotation by zero:
<code>rotate %t, 0</code> folds away to <code>%t</code></p></li><li><p>Cyclical wraparound:
<code>rotate %t, k</code> for $k > t.size$ can be simplified to <code>rotate %t, (k mod t.size)</code></p></li><li><p>Sequential rotation:
<code>%0 = rotate %t, k</code> followed by <code>%1 = rotate %0, l</code> is simplified to <code>rotate %t (k+l)</code></p></li><li><p>Extraction:
<code>%0 = rotate %t, k</code> followed by <code>%1 = tensor.extract %0[l]</code> is simplified to <code>tensor.extract %t[k+l]</code></p></li><li><p>Binary Arithmetic Ops:
where both operands to a binary <code>arith</code> operation are rotations by the same amount, the rotation can be performed only once, on the result.
For Example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span></code></pre></div><p>can be simplified to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%t2</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span></code></pre></div></li><li><p><em>Sandwiched</em> Binary Arithmetic Ops:
If a rotation follows a binary <code>arith</code> operation which has rotation as its operands, the post-arith operation can be moved forward.
For example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>y</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>z</span>
</span></span></code></pre></div><p>can be simplified to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>x</span> <span style=color:#a40000>+</span> <span style=color:#a40000>z</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>y</span> <span style=color:#a40000>+</span> <span style=color:#a40000>z</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span></code></pre></div></li><li><p>Single-Use Arithmetic Ops:
Finally, there is a pair of rules that do not eliminate rotations, but move rotations up in the IR, which can help in exposing further canonicalization and/or CSE opportunities.
These only apply to <code>arith</code> operations with a single use, as they might otherwise increase the total number of rotations.
For example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%t2</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>l</span>
</span></span></code></pre></div><p>can be equivalently rewritten as</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>(</span><span style=color:#a40000>k+l</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>l</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span></code></pre></div><p>and a similar pattern exists for situations where the rotation is the rhs operand of the arithmetic operation.</p></li></ul><p>Note that the index computations in the patterns above (e.g., <code>k+l</code>, <code>k mod t.size</code> are realized via emitting <code>arith</code> operations.
However, for constant/compile-time-known indices, these will be subsequently constant-folded away by the canonicalization pass.</p><div class="text-muted mt-5 pt-3 border-top">Last modified June 6, 2024: <a href=https://github.com/google/heir/commit/9e76b6e4a7bced1fe77b6342f8f294a79070d5c0>SIMD (HECO batching opt) design doc (9e76b6e4)</a></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/google/heir aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2024 The HEIR Authors All Rights Reserved</span>
<span class=ms-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.027d75d71824837bee74c12a7806c5fe51249c1ca7accc27553a251a75cdb3a4.js integrity="sha256-An111xgkg3vudMEqeAbF/lEknBynrMwnVTolGnXNs6Q=" crossorigin=anonymous></script>
<script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>