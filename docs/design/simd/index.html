<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.113.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>SIMD Optimizations | HEIR</title><meta name=description content="HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE schemes support (also commonly known as &amp;ldquo;packing&amp;rdquo; or &amp;ldquo;batching&amp;rdquo;). Specifically, HEIR incorporates the &amp;ldquo;automated batching&amp;rdquo; optimizations (among many other things) from the HECO compiler. The following will assume basic familiarity with the FHE SIMD paradigm and the high-level goals of the optimization, and we refer to the associated HECO paper, slides, talk and additional resources on the Usenix'23 website for an introduction to the topic."><meta property="og:title" content="SIMD Optimizations"><meta property="og:description" content="HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE schemes support (also commonly known as &ldquo;packing&rdquo; or &ldquo;batching&rdquo;). Specifically, HEIR incorporates the &ldquo;automated batching&rdquo; optimizations (among many other things) from the HECO compiler. The following will assume basic familiarity with the FHE SIMD paradigm and the high-level goals of the optimization, and we refer to the associated HECO paper, slides, talk and additional resources on the Usenix'23 website for an introduction to the topic."><meta property="og:type" content="article"><meta property="og:url" content="https://heir.dev/docs/design/simd/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2025-10-17T09:48:09-07:00"><meta itemprop=name content="SIMD Optimizations"><meta itemprop=description content="HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE schemes support (also commonly known as &ldquo;packing&rdquo; or &ldquo;batching&rdquo;). Specifically, HEIR incorporates the &ldquo;automated batching&rdquo; optimizations (among many other things) from the HECO compiler. The following will assume basic familiarity with the FHE SIMD paradigm and the high-level goals of the optimization, and we refer to the associated HECO paper, slides, talk and additional resources on the Usenix'23 website for an introduction to the topic."><meta itemprop=dateModified content="2025-10-17T09:48:09-07:00"><meta itemprop=wordCount content="1820"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="SIMD Optimizations"><meta name=twitter:description content="HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE schemes support (also commonly known as &ldquo;packing&rdquo; or &ldquo;batching&rdquo;). Specifically, HEIR incorporates the &ldquo;automated batching&rdquo; optimizations (among many other things) from the HECO compiler. The following will assume basic familiarity with the FHE SIMD paradigm and the high-level goals of the optimization, and we refer to the associated HECO paper, slides, talk and additional resources on the Usenix'23 website for an introduction to the topic."><link rel=preload href=/scss/main.min.dffc1689fd83830a5fb090d38ca9680587c322008ad97c675ee0ca22e5fb10d5.css as=style><link href=/scss/main.min.dffc1689fd83830a5fb090d38ca9680587c322008ad97c675ee0ca22e5fb10d5.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script>
<script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body class=td-page><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="32" height="32" fill="#fff" fill-opacity=".01"/><path d="M18.6889 10.124l7.7916 5.0511 2.6263-1.6684-2.6146-1.6779-7.8033-4.96754 2.8526 1.84162L18.6889 10.124z" fill="#efcf6f"/><path d="M29.1185 6.86125 18.6979.13981 16.06 1.79876 26.4922 8.52025l2.6263-1.659z" fill="#efcf6f"/><path d="M8.2405 6.74134 5.60033 5.07291 3.05751 6.79935 5.67334 8.49344 8.2405 6.74134z" fill="#ee958a"/><path d="M10.8697 8.49344 8.2405 10.124v3.3995l5.2049-3.3348-2.5757-1.69526z" fill="#ee958a"/><path d="M5.67334 8.49344 3.05751 6.79935 3.03318 23.4932l2.64016 1.6897V8.49344z" fill="#a32e24"/><path d="M29.1185 6.86126 26.4922 8.52025V11.8288l2.6263-1.6401V6.86126z" fill="#d38041"/><path d="M21.5415 8.70288 18.6889 6.86126V10.124l2.8526-1.42112z" fill="#d38041"/><path fill-rule="evenodd" clip-rule="evenodd" d="M8.2405 6.74134V10.124v3.3995l5.2049-3.3348V3.58723l2.6145-1.7885L16.1123 11.8484V18.467l-2.6158 1.6181L13.4574 13.5235 10.849 15.1694 8.2405 16.8152v6.678L5.67334 25.1829V8.49344L8.2405 6.74134z" fill="#dd583b"/><path d="M13.4965 20.0851 13.4574 13.5235 10.849 15.1694 10.8077 18.467l2.6888 1.6181z" fill="#a32e24"/><path fill-rule="evenodd" clip-rule="evenodd" d="M13.4454 3.58723V10.1887L10.8697 8.49344 10.9293 1.79873l2.5161 1.7885z" fill="#a32e24"/><path d="M16.0599 1.79873 13.4454.13981 10.9293 1.79873l2.5161 1.7885 2.6145-1.7885z" fill="#ee958a"/><path d="M16.06 1.79876 16.0793 5.52165 16.1123 11.8484V18.467l2.5766-1.6518V13.4696 10.124 6.86126l7.8033 4.96754V8.52025L16.06 1.79876z" fill="#e5ad11"/><path d="M18.6889 16.8152 16.1123 18.467l10.3682 6.7159V21.8372l-7.7916-5.022z" fill="#e5ad11"/><path d="M26.4805 15.1751 18.6889 10.124v3.3456l2.7505 1.7641 5.0411 3.2333V15.1751z" fill="#e5ad11"/><path d="M29.1068 13.5067l-2.6263 1.6684V18.467l2.6263-1.6518V13.5067z" fill="#d48041"/><path d="M29.1185 20.0851l-2.638 1.7521v3.3457l2.6263-1.6897L29.1185 20.0851z" fill="#d48041"/><path fill-rule="evenodd" clip-rule="evenodd" d="M26.4805 21.8372l-7.7916-5.022 2.7505-1.5815 5.0411 3.2333 2.638 1.6181-2.638 1.7521z" fill="#efcf6f"/><path d="M18.6889 13.4696v3.3456l2.7505-1.5815-2.7505-1.7641z" fill="#d48041"/><path d="M20.1621 26.5165l-4.2015-2.7017-4.2015-2.7016L11.7108 23.8491l6.3384 4.0776 2.1129 1.3512V26.5165z" fill="#395aad"/><path d="M7.49852 23.8491v2.6674l8.41958 5.4439V29.2779L7.49852 23.8491z" fill="#276e3a"/><path d="M9.57951 22.4781l-2.08099 1.371 8.41958 5.4288 2.1311-1.3512-6.3384-4.0776-2.13129-1.371z" fill="#add284"/><path d="M24.3747 26.5165V23.8491L22.174 22.8377l-2.0054.9665 2.1815 1.3793 2.0246 1.333z" fill="#395aad"/><path d="M18.0492 19.7061l2.1194 1.431-2.048 1.3721-2.1698-1.3721 2.0984-1.431z" fill="#395aad"/><path fill-rule="evenodd" clip-rule="evenodd" d="M20.1621 18.4432l-2.0415-.596-2.1581.596-2.1017 1.3349-2.1017 1.3351 2.1012 1.3511 6.3018 4.0522 2.188-1.333-2.1815-1.3793 2.0054-.9665 2.2007 1.0114 2.0995-1.329-2.0811-1.4069L22.3501 21.1371l-.1752-1.4237L22.174 19.7061l-2.0119-1.2629zm-2.1129 1.2629 2.1194 1.431-2.048 1.3721-2.1698-1.3721 2.0984-1.431z" fill="#9ec4e0"/><path d="M26.4742 22.5201l-2.0995 1.329v2.6674l2.1289-1.3305L26.4742 22.5201z" fill="#4285f4"/><path d="M20.1621 26.5165v2.7614l2.188-1.3512V25.1835l-2.188 1.333z" fill="#4285f4"/><path d="M15.9181 29.2779v2.6825l2.1311-1.3708V27.9267l-2.1311 1.3512z" fill="#4e9c68"/></svg></span><span class=navbar-brand__name>HEIR</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class="nav-link active" href=/><span>Home</span></a></li><li class=nav-item><a class="nav-link active" href=/docs/><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/community/><span>Community</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/google/heir/ target=_blank rel=noopener><span>GitHub</span></a></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m--li><a href=/ title="HEIR: Homomorphic Encryption Intermediate Representation" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-><span>Home</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ title=Documentation class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docs><span>Docs</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting_started-li><a href=/docs/getting_started/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsgetting_started><span>Getting Started</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsdevelopment-li><a href=/docs/development/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsdevelopment><span>Development</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdevelopmentbazel-li><a href=/docs/development/bazel/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentbazel><span>Bazel tips</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdevelopmentboilerplate-li><a href=/docs/development/boilerplate/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentboilerplate><span>Boilerplate tools</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdevelopmentide-li><a href=/docs/development/ide/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentide><span>IDE configuration</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorials-li><a href=/docs/tutorials/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorials><span>Tutorials and Talks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsresearch_with_heir-li><a href=/docs/research_with_heir/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsresearch_with_heir><span>Research with HEIR</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsdesign-li><a href=/docs/design/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsdesign><span>Design</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignmanagement-li><a href=/docs/design/management/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignmanagement><span>Ciphertext Management</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignlayout-li><a href=/docs/design/layout/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignlayout><span>Ciphertext Packing System</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesigndo_transformation-li><a href=/docs/design/do_transformation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesigndo_transformation><span>Data-oblivious Transformations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignnoise-li><a href=/docs/design/noise/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignnoise><span>Noise Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignsecret-li><a href=/docs/design/secret/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignsecret><span>Secret</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsdesignsimd-li><a href=/docs/design/simd/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docsdesignsimd><span class=td-sidebar-nav-active-item>SIMD Optimizations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdesignrelinearization_ilp-li><a href=/docs/design/relinearization_ilp/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignrelinearization_ilp><span>Optimizing relinearization</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docspipelines-li><a href=/docs/pipelines/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspipelines><span>Pipelines</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsdialects-li><a href=/docs/dialects/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsdialects><span>Dialects</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsbgv-li><a href=/docs/dialects/bgv/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsbgv><span>BGV</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectscggi-li><a href=/docs/dialects/cggi/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectscggi><span>CGGI</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsckks-li><a href=/docs/dialects/ckks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsckks><span>CKKS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectscomb-li><a href=/docs/dialects/comb/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectscomb><span>Comb</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsjaxite-li><a href=/docs/dialects/jaxite/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsjaxite><span>Jaxite</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsjaxiteword-li><a href=/docs/dialects/jaxiteword/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsjaxiteword><span>JaxiteWord</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectslattigo-li><a href=/docs/dialects/lattigo/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectslattigo><span>Lattigo</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectslwe-li><a href=/docs/dialects/lwe/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectslwe><span>LWE</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsmathext-li><a href=/docs/dialects/mathext/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsmathext><span>MathExt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsmgmt-li><a href=/docs/dialects/mgmt/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsmgmt><span>Mgmt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsmodarith-li><a href=/docs/dialects/modarith/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsmodarith><span>ModArith</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsopenfhe-li><a href=/docs/dialects/openfhe/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsopenfhe><span>Openfhe</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectspolynomial-li><a href=/docs/dialects/polynomial/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectspolynomial><span>Polynomial</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsrandom-li><a href=/docs/dialects/random/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsrandom><span>Random</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsrns-li><a href=/docs/dialects/rns/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsrns><span>RNS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectssecret-li><a href=/docs/dialects/secret/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectssecret><span>Secret</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstensorext-li><a href=/docs/dialects/tensorext/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstensorext><span>TensorExt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstfherust-li><a href=/docs/dialects/tfherust/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstfherust><span>TfheRust</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstfherustbool-li><a href=/docs/dialects/tfherustbool/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstfherustbool><span>TfheRustBool</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docspasses-li><a href=/docs/passes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspasses><span>Passes</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-community-li><a href=/community/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-community><span>Community</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-search-li><a href=/search/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-search><span>Search Results</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a id=print href=https://heir.dev/docs/design/_print/><i class="fa-solid fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#representing-fhe-simd-operations>Representing FHE SIMD Operations</a></li><li><a href=#intended-usage>Intended Usage</a></li><li><a href=#implementation>Implementation</a><ul><li><a href=#components>Components</a></li><li><a href=#high-level-flow>High-Level Flow</a></li><li><a href=#insert-rotate-pass>Insert Rotate Pass</a></li><li><a href=#tensorext-canonicalization>TensorExt Canonicalization</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://heir.dev/docs/>Docs</a></li><li class=breadcrumb-item><a href=https://heir.dev/docs/design/>Design</a></li><li class="breadcrumb-item active" aria-current=page>SIMD Optimizations</li></ol></nav><div class=td-content><h1>SIMD Optimizations</h1><header class=article-meta></header><p>HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is
designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE
schemes support (also commonly known as &ldquo;packing&rdquo; or &ldquo;batching&rdquo;). Specifically,
HEIR incorporates the &ldquo;automated batching&rdquo; optimizations (among many other
things) from the <a href=https://github.com/MarbleHE/HECO>HECO</a> compiler. The
following will assume basic familiarity with the FHE SIMD paradigm and the
high-level goals of the optimization, and we refer to the associated HECO
<a href=https://www.usenix.org/system/files/usenixsecurity23-viand.pdf>paper</a>,
<a href=https://www.usenix.org/system/files/sec23_slides_viand.pdf>slides</a>,
<a href="https://www.youtube.com/watch?v=SP3C6gLWIS4">talk</a> and additional resources on
the
<a href=https://www.usenix.org/conference/usenixsecurity23/presentation/viand>Usenix'23 website</a>
for an introduction to the topic. This documentation will mostly focus on
describing how the optimization is realized in HEIR (which differs somewhat from
the original implementation) and how the optimization is intended to be used in
an overall end-to-end compilation pipeline.</p><h2 id=representing-fhe-simd-operations>Representing FHE SIMD Operations</h2><p>Following the design principle of maintaining programs in standard MLIR dialects
as long as possible (cf. the design rationale behind the
<a href=https://heir.dev/docs/design/secret/>Secret Dialect</a>), HEIR uses the MLIR
<a href=https://mlir.llvm.org/docs/Dialects/TensorOps/><code>tensor</code> dialect</a> and
<a href=https://mlir.llvm.org/docs/Traits/#elementwisemappable>ElementwiseMappable</a>
operations from the MLIR
<a href=https://mlir.llvm.org/docs/Dialects/ArithOps/><code>arith</code> dialect</a> to represent HE
SIMD operations.</p><p>We do introduce the HEIR-specific
<a href=https://heir.dev/docs/dialects/tensorext/#tensor_extrotate-heirtensor_extrotateop><code>tensor_ext.rotate</code></a>
operation, which represents a cyclical left-rotation of a tensor. Note that, as
the current SIMD vectorizer only supports one-dimensional tensors, the semantics
of this operation on multi-dimensional tensors are not (currently) defined.</p><p>For example, the common &ldquo;rotate-and-reduce&rdquo; pattern which results in each
element containing the sum/product/etc of the original vector can be expressed
as:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%tensor</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>from_elements</span> <span style=color:#000>%i1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i6</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i8</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c4</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%0</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%4</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>The <code>%cN</code> and <code>%iN</code>, which are defined as <code>%cN = arith.constant N : index</code> and
<code>%iN = arith.constant N : i16</code>, respectively, have been omitted for readability.</p><h2 id=intended-usage>Intended Usage</h2><p>The <code>-heir-simd-vectorizer</code> pipeline transforms a program consisting of loops
and index-based accesses into tensors (e.g., <code>tensor.extract</code> and
<code>tensor.insert</code>) into one consisting of SIMD operations (including rotations) on
entire tensors. While its implementation does not depend on any FHE-specific
details or even the Secret dialect, this transformation is likely only useful
when lowering a high-level program to an arithmetic-circuit-based FHE scheme
(e.g., B/FV, BGV, or CKKS). The <code>--mlir-to-bgv --scheme-to-openfhe</code> pipeline
demonstrates the intended flow: augmenting a high-level program with <code>secret</code>
annotations, then applying the SIMD optimization (and any other high-level
optimizations) before lowering to BGV operations and then exiting to OpenFHE.</p><blockquote><p><strong>Warning</strong> The current SIMD vectorizer pipeline supports only one-dimensional
tensors. As a workaround, one could reshape all multi-dimensional tensors into
one-dimensional tensors, but MLIR/HEIR currently do not provide a pass to
automate this process.</p></blockquote><p>Since the optimization is based on heuristics, the resulting program might not
be optimal or could even be worse than a trivial realization that does not use
ciphertext packing. However, well-structured programs generally lower to
reasonable batched solutions, even if they do not achieve optimal batching
layouts. For common operations such as matrix-vector or matrix-matrix
multiplications, state-of-the-art approaches require advanced packing schemes
that might map elements into the ciphertext vector in non-trivial ways (e.g.,
diagonal-major and/or replicated). The current SIMD vectorizer will never change
the arrangement of elements inside an input tensor and therefore cannot produce
the optimal approaches for these operations.</p><p>Note, that the SIMD batching optimization is different from, and significantly
more complex than, the Straight Line Vectorizer (<code>-straight-line-vectorize</code>
pass), which simply groups
<a href=https://mlir.llvm.org/docs/Traits/#elementwisemappable>ElementwiseMappable</a>
operations that agree in operation name and operand/result types into
vectorized/tensorized versions.</p><h2 id=implementation>Implementation</h2><p>Below, we give a brief overview over the implementation, with the goal of both
improving maintainability/extensibility of the SIMD vectorizer and allowing
advanced users to better understand why a certain program is transformed in the
way it is.</p><h3 id=components>Components</h3><p>The <code>-heir-simd-vectorizer</code> pipeline uses a combination of standard MLIR passes
(<a href=https://mlir.llvm.org/docs/Passes/#-canonicalize><code>-canonicalize</code></a>,
<a href=https://mlir.llvm.org/docs/Passes/#-cse><code>-cse</code></a>,
<a href=https://mlir.llvm.org/docs/Passes/#-sccp><code>-sccp</code></a>) and custom HEIR passes.
Some of these
(<a href=https://heir.dev/docs/passes/applyfolderspasses/#-apply-folders><code>-apply-folders</code></a>,
<a href=https://heir.dev/docs/passes/fullloopunrollpasses/#-full-loop-unroll><code>-full-loop-unroll</code></a>)
might have applications outside the SIMD optimization, while others
(<a href=https://heir.dev/docs/passes/tensorextpasses/#-insert-rotate><code>-insert-rotate</code></a>,
<a href=https://heir.dev/docs/passes/tensorextpasses/#-collapse-insertion-chains><code>-collapse-insertion-chains</code></a>
and
<a href=https://heir.dev/docs/passes/tensorextpasses/#-rotate-and-reduce><code>-rotate-and-reduce</code></a>)
are very specific to the FHE SIMD optimization. In addition, the passes make use
of the <code>RotationAnalysis</code> and <code>TargetSlotAnalysis</code> analyses.</p><h3 id=high-level-flow>High-Level Flow</h3><ul><li><p><strong>Loop Unrolling</strong> (<code>-full-loop-unroll</code>): The implementation currently begins
by unrolling all loops in the program to simplify the later passes. See
<a href=https://github.com/google/heir/issues/589>#589</a> for a discussion on how this
could be avoided.</p></li><li><p><strong>Canonicalization</strong> (<code>-apply-folders -canonicalize</code>): As the
rotation-specific passes are very strict about the structure of the IR they
operate on, we must first simplify away things such as tensors of constant
values. For performance reasons (c.f. comments in the
<code>heirSIMDVectorizerPipelineBuilder</code> function in <code>heir-opt.cpp</code>), this must be
done by first applying
<a href=https://mlir.llvm.org/docs/Canonicalization/#canonicalizing-with-the-fold-method>folds</a>
before applying the full
<a href=https://mlir.llvm.org/docs/Canonicalization/>canonicalization</a>.</p></li><li><p><strong>Main SIMD Rewrite</strong> (<code>-insert-rotate -cse -canonicalize -cse</code>): This pass
rewrites arithmetic operations over <code>tensor.extract</code>-ed operands into SIMD
operations over the entire tensor, rotating the (full-tensor) operands so that
the correct elements interact. For example, it will rewrite the following
snippet (which computes <code>t2[4] = t0[3] + t1[5]</code>)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>extract</span> <span style=color:#000>%t0</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c3</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>extract</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c5</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span> <span style=color:#a40000>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>insert</span> <span style=color:#000>%2</span> <span style=color:#a40000>in</span><span style=color:#204a87;font-weight:700>to</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%t0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c31</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>i.e., rotating <code>t0</code> down by one (31 = -1 (mod 32)) and <code>t1</code> up by one to bring
the elements at index 3 and 5, respectively, to the &ldquo;target&rdquo; index 4. The pass
uses the <code>TargetSlotAnalysis</code> to identify the appropriate target index (or
ciphertext &ldquo;slot&rdquo; in FHE-speak). See <a href=#insert-rotate-pass>Insert Rotate Pass</a>
below for more details. This pass is roughly equivalent to the <code>-batching</code>
pass in the original HECO implementation.</p><p>Doing this rewrite by itself does not represent an optimization, but if we
consider what happens to the corresponding code for other indices (e.g.,
<code>t2[5] = t0[4] + t1[6]</code>), we see that the pass transforms expressions with the
same relative index offsets into the exact same set of rotations/SIMD
operations, so the following
<a href=https://en.wikipedia.org/wiki/Common_subexpression_elimination>Common Subexpression Elimination (CSE)</a>
will remove redundant computations. We apply CSE twice, once directly (which
creates new opportunities for canonicalization and folding) and then again
after that canonicalization. See
<a href=#tensorext-canonicalization>TensorExt Canonicalization</a> for a description of
the rotation-specific canonocalization patterns).</p></li><li><p><strong>Cleanup of Redundant Insert/Extract</strong>
(<code>-collapse-insertion-chains -sccp -canonicalize -cse</code>): Because the
<code>-insert-rotate</code> pass maintains the consistency of the IR, it emits a
<code>tensor.extract</code> operation after the SIMD operation and uses that to replace
the original operation (which is valid, as both produce the desired scalar
result). As a consequence, the generated code for the snippet above is
actually trailed by a (redundant) extract/insert:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>extract</span> <span style=color:#000>%2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%inserted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>insert</span> <span style=color:#000>%extracted</span> <span style=color:#a40000>in</span><span style=color:#204a87;font-weight:700>to</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>In real code, this might generate a long series of such extraction/insertion
operations, all extracting from the same (due to CSE) tensor and inserting
into the same output tensor. Therefore, the <code>-collapse-insertion-chains</code> pass
searches for such chains over entire tensors and collapses them. It supports
not just chains where the indices match perfectly, but any chain where the
relative offset is consistent across the tensor, issuing a rotation to realize
the offset (if the offset is zero, the canonicalization will remove the
redundant rotation). Note, that in HECO, insertion/extraction is handled
differently, as HECO features a <code>combine</code> operation modelling not just simple
insertions (<code>combine(%t0#j, %t1)</code>) but also more complex operations over
slices of tensors (<code>combine(%t0#[i,j], %t1)</code>). As a result, the equivalent
pass in HECO (<code>-combine-simplify</code>) instead joins different <code>combine</code>
operations, and a later fold removes <code>combines</code> that replace the entire target
tensor. See issue <a href=https://github.com/google/heir/issues/512>#512</a> for a
discussion on why the <code>combine</code> operation is a more powerful framework and
what would be necessary to port it to HEIR.</p></li><li><p><strong>Applying Rotate-and-Reduce Patterns</strong>
(<code>-rotate-and-reduce -sccp -canonicalize -cse</code>): The rotate and reduce pattern
(see <a href=#representing-fhe-simd-operations>Representing FHE SIMD Operations</a> for
an example) is an important aspect of accelerating SIMD-style operations in
FHE, but it does not follow automatically from the batching rewrites applied
so far. As a result, the <code>-rotate-and-reduce</code> pass needs to search for
sequences of arithmetic operations that correspond to the full folding of a
tensor, i.e., patterns such as <code>t[0]+(t[1]+(t[2]+t[3]+(...)))</code>, which
currently uses a backwards search through the IR, but could be achieved more
efficiently through a data flow analysis (c.f. issue
<a href=https://github.com/google/heir/issues/523>#532</a>). In HECO, rotate-and-reduce
is handled differently, by identifying sequences of compatible operations
prior to batching and rewriting them to &ldquo;n-ary&rdquo; operations. However, this
approach requires non-standard arithmetic operations and is therefore not
suitable for use in HEIR. However, there is likely still an opportunity to
make the patterns in HEIR more robust/general (e.g., support constant scalar
operands in the fold, or support non-full-tensor folds). See issue
<a href=https://github.com/google/heir/issues/522>#522</a> for ideas on how to make the
HEIR pattern more robust/more general.</p></li></ul><h3 id=insert-rotate-pass>Insert Rotate Pass</h3><p>TODO(#721): Write a detailed description of the rotation insertion pass and the
associated target slot analysis.</p><h3 id=tensorext-canonicalization>TensorExt Canonicalization</h3><p>The
<a href=https://heir.dev/docs/dialects/tensorext/>TensorExt (<code>tensor_ext</code>) Dialect</a>
includes a series of canonicalization rules that are essential to making
automatically generated rotation code efficient:</p><ul><li><p>Rotation by zero: <code>rotate %t, 0</code> folds away to <code>%t</code></p></li><li><p>Cyclical wraparound: <code>rotate %t, k</code> for $k > t.size$ can be simplified to
<code>rotate %t, (k mod t.size)</code></p></li><li><p>Sequential rotation: <code>%0 = rotate %t, k</code> followed by <code>%1 = rotate %0, l</code> is
simplified to <code>rotate %t (k+l)</code></p></li><li><p>Extraction: <code>%0 = rotate %t, k</code> followed by <code>%1 = tensor.extract %0[l]</code> is
simplified to <code>tensor.extract %t[k+l]</code></p></li><li><p>Binary Arithmetic Ops: where both operands to a binary <code>arith</code> operation are
rotations by the same amount, the rotation can be performed only once, on the
result. For Example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span></code></pre></div><p>can be simplified to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%t2</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span></code></pre></div></li><li><p><em>Sandwiched</em> Binary Arithmetic Ops: If a rotation follows a binary <code>arith</code>
operation which has rotation as its operands, the post-arith operation can be
moved forward. For example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>y</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>z</span>
</span></span></code></pre></div><p>can be simplified to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>x</span> <span style=color:#a40000>+</span> <span style=color:#a40000>z</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>y</span> <span style=color:#a40000>+</span> <span style=color:#a40000>z</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span></code></pre></div></li><li><p>Single-Use Arithmetic Ops: Finally, there is a pair of rules that do not
eliminate rotations, but move rotations up in the IR, which can help in
exposing further canonicalization and/or CSE opportunities. These only apply
to <code>arith</code> operations with a single use, as they might otherwise increase the
total number of rotations. For example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%t2</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>l</span>
</span></span></code></pre></div><p>can be equivalently rewritten as</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>(</span><span style=color:#a40000>k+l</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>l</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span></code></pre></div><p>and a similar pattern exists for situations where the rotation is the rhs
operand of the arithmetic operation.</p></li></ul><p>Note that the index computations in the patterns above (e.g., <code>k+l</code>,
<code>k mod t.size</code> are realized via emitting <code>arith</code> operations. However, for
constant/compile-time-known indices, these will be subsequently constant-folded
away by the canonicalization pass.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/google/heir aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2025 The HEIR Authors All Rights Reserved</span>
<span class=ms-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.027d75d71824837bee74c12a7806c5fe51249c1ca7accc27553a251a75cdb3a4.js integrity="sha256-An111xgkg3vudMEqeAbF/lEknBynrMwnVTolGnXNs6Q=" crossorigin=anonymous></script>
<script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>