<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.113.0"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Passes | HEIR</title><meta name=description content="-add-client-interface Add client interfaces to secret functions
This pass adds encrypt and decrypt functions for each compiled function in the IR. These functions maintain the same interface as the original function, while the compiled function may lose some of this information by the lowerings to ciphertext types (e.g., a scalar ciphertext, when lowered through RLWE schemes, must be encoded as a tensor).
This pass occurs at the secret level, which is necessary because some backends like the plaintext backend don&amp;rsquo;t actually encrypt, but still require the ciphertext layout/packing logic to convert cleartexts to plaintexts."><meta property="og:title" content="Passes"><meta property="og:description" content="-add-client-interface Add client interfaces to secret functions
This pass adds encrypt and decrypt functions for each compiled function in the IR. These functions maintain the same interface as the original function, while the compiled function may lose some of this information by the lowerings to ciphertext types (e.g., a scalar ciphertext, when lowered through RLWE schemes, must be encoded as a tensor).
This pass occurs at the secret level, which is necessary because some backends like the plaintext backend don&rsquo;t actually encrypt, but still require the ciphertext layout/packing logic to convert cleartexts to plaintexts."><meta property="og:type" content="article"><meta property="og:url" content="https://heir.dev/docs/passes/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-10-21T23:00:12-07:00"><meta itemprop=name content="Passes"><meta itemprop=description content="-add-client-interface Add client interfaces to secret functions
This pass adds encrypt and decrypt functions for each compiled function in the IR. These functions maintain the same interface as the original function, while the compiled function may lose some of this information by the lowerings to ciphertext types (e.g., a scalar ciphertext, when lowered through RLWE schemes, must be encoded as a tensor).
This pass occurs at the secret level, which is necessary because some backends like the plaintext backend don&rsquo;t actually encrypt, but still require the ciphertext layout/packing logic to convert cleartexts to plaintexts."><meta itemprop=dateModified content="2024-10-21T23:00:12-07:00"><meta itemprop=wordCount content="11863"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Passes"><meta name=twitter:description content="-add-client-interface Add client interfaces to secret functions
This pass adds encrypt and decrypt functions for each compiled function in the IR. These functions maintain the same interface as the original function, while the compiled function may lose some of this information by the lowerings to ciphertext types (e.g., a scalar ciphertext, when lowered through RLWE schemes, must be encoded as a tensor).
This pass occurs at the secret level, which is necessary because some backends like the plaintext backend don&rsquo;t actually encrypt, but still require the ciphertext layout/packing logic to convert cleartexts to plaintexts."><link rel=preload href=/scss/main.min.dffc1689fd83830a5fb090d38ca9680587c322008ad97c675ee0ca22e5fb10d5.css as=style><link href=/scss/main.min.dffc1689fd83830a5fb090d38ca9680587c322008ad97c675ee0ca22e5fb10d5.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script>
<script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body class=td-page><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="32" height="32" fill="#fff" fill-opacity=".01"/><path d="M18.6889 10.124l7.7916 5.0511 2.6263-1.6684-2.6146-1.6779-7.8033-4.96754 2.8526 1.84162L18.6889 10.124z" fill="#efcf6f"/><path d="M29.1185 6.86125 18.6979.13981 16.06 1.79876 26.4922 8.52025l2.6263-1.659z" fill="#efcf6f"/><path d="M8.2405 6.74134 5.60033 5.07291 3.05751 6.79935 5.67334 8.49344 8.2405 6.74134z" fill="#ee958a"/><path d="M10.8697 8.49344 8.2405 10.124v3.3995l5.2049-3.3348-2.5757-1.69526z" fill="#ee958a"/><path d="M5.67334 8.49344 3.05751 6.79935 3.03318 23.4932l2.64016 1.6897V8.49344z" fill="#a32e24"/><path d="M29.1185 6.86126 26.4922 8.52025V11.8288l2.6263-1.6401V6.86126z" fill="#d38041"/><path d="M21.5415 8.70288 18.6889 6.86126V10.124l2.8526-1.42112z" fill="#d38041"/><path fill-rule="evenodd" clip-rule="evenodd" d="M8.2405 6.74134V10.124v3.3995l5.2049-3.3348V3.58723l2.6145-1.7885L16.1123 11.8484V18.467l-2.6158 1.6181L13.4574 13.5235 10.849 15.1694 8.2405 16.8152v6.678L5.67334 25.1829V8.49344L8.2405 6.74134z" fill="#dd583b"/><path d="M13.4965 20.0851 13.4574 13.5235 10.849 15.1694 10.8077 18.467l2.6888 1.6181z" fill="#a32e24"/><path fill-rule="evenodd" clip-rule="evenodd" d="M13.4454 3.58723V10.1887L10.8697 8.49344 10.9293 1.79873l2.5161 1.7885z" fill="#a32e24"/><path d="M16.0599 1.79873 13.4454.13981 10.9293 1.79873l2.5161 1.7885 2.6145-1.7885z" fill="#ee958a"/><path d="M16.06 1.79876 16.0793 5.52165 16.1123 11.8484V18.467l2.5766-1.6518V13.4696 10.124 6.86126l7.8033 4.96754V8.52025L16.06 1.79876z" fill="#e5ad11"/><path d="M18.6889 16.8152 16.1123 18.467l10.3682 6.7159V21.8372l-7.7916-5.022z" fill="#e5ad11"/><path d="M26.4805 15.1751 18.6889 10.124v3.3456l2.7505 1.7641 5.0411 3.2333V15.1751z" fill="#e5ad11"/><path d="M29.1068 13.5067l-2.6263 1.6684V18.467l2.6263-1.6518V13.5067z" fill="#d48041"/><path d="M29.1185 20.0851l-2.638 1.7521v3.3457l2.6263-1.6897L29.1185 20.0851z" fill="#d48041"/><path fill-rule="evenodd" clip-rule="evenodd" d="M26.4805 21.8372l-7.7916-5.022 2.7505-1.5815 5.0411 3.2333 2.638 1.6181-2.638 1.7521z" fill="#efcf6f"/><path d="M18.6889 13.4696v3.3456l2.7505-1.5815-2.7505-1.7641z" fill="#d48041"/><path d="M20.1621 26.5165l-4.2015-2.7017-4.2015-2.7016L11.7108 23.8491l6.3384 4.0776 2.1129 1.3512V26.5165z" fill="#395aad"/><path d="M7.49852 23.8491v2.6674l8.41958 5.4439V29.2779L7.49852 23.8491z" fill="#276e3a"/><path d="M9.57951 22.4781l-2.08099 1.371 8.41958 5.4288 2.1311-1.3512-6.3384-4.0776-2.13129-1.371z" fill="#add284"/><path d="M24.3747 26.5165V23.8491L22.174 22.8377l-2.0054.9665 2.1815 1.3793 2.0246 1.333z" fill="#395aad"/><path d="M18.0492 19.7061l2.1194 1.431-2.048 1.3721-2.1698-1.3721 2.0984-1.431z" fill="#395aad"/><path fill-rule="evenodd" clip-rule="evenodd" d="M20.1621 18.4432l-2.0415-.596-2.1581.596-2.1017 1.3349-2.1017 1.3351 2.1012 1.3511 6.3018 4.0522 2.188-1.333-2.1815-1.3793 2.0054-.9665 2.2007 1.0114 2.0995-1.329-2.0811-1.4069L22.3501 21.1371l-.1752-1.4237L22.174 19.7061l-2.0119-1.2629zm-2.1129 1.2629 2.1194 1.431-2.048 1.3721-2.1698-1.3721 2.0984-1.431z" fill="#9ec4e0"/><path d="M26.4742 22.5201l-2.0995 1.329v2.6674l2.1289-1.3305L26.4742 22.5201z" fill="#4285f4"/><path d="M20.1621 26.5165v2.7614l2.188-1.3512V25.1835l-2.188 1.333z" fill="#4285f4"/><path d="M15.9181 29.2779v2.6825l2.1311-1.3708V27.9267l-2.1311 1.3512z" fill="#4e9c68"/></svg></span><span class=navbar-brand__name>HEIR</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class="nav-link active" href=/><span>Home</span></a></li><li class=nav-item><a class="nav-link active" href=/docs/><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/community/><span>Community</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/google/heir/ target=_blank rel=noopener><span>GitHub</span></a></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m--li><a href=/ title="HEIR: Homomorphic Encryption Intermediate Representation" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-><span>Home</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ title=Documentation class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docs><span>Docs</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsgetting_started-li><a href=/docs/getting_started/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsgetting_started><span>Getting Started</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributing-li><a href=/docs/contributing/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributing><span>Contributing to HEIR</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopment-li><a href=/docs/development/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopment><span>Development</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docstutorials-li><a href=/docs/tutorials/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docstutorials><span>Tutorials and Talks</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsresearch_with_heir-li><a href=/docs/research_with_heir/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsresearch_with_heir><span>Research with HEIR</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsdesign-li><a href=/docs/design/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsdesign><span>Design</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdesignmanagement-li><a href=/docs/design/management/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignmanagement><span>Ciphertext Management</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdesigndo_transformation-li><a href=/docs/design/do_transformation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesigndo_transformation><span>Data-oblivious Transformations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdesignnoise-li><a href=/docs/design/noise/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignnoise><span>Noise Analysis</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdesignsecret-li><a href=/docs/design/secret/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignsecret><span>Secret</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdesignsimd-li><a href=/docs/design/simd/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignsimd><span>SIMD Optimizations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdesignrelinearization_ilp-li><a href=/docs/design/relinearization_ilp/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdesignrelinearization_ilp><span>Optimizing relinearization</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docspipelines-li><a href=/docs/pipelines/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docspipelines><span>Pipelines</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsdialects-li><a href=/docs/dialects/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsdialects><span>Dialects</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsbgv-li><a href=/docs/dialects/bgv/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsbgv><span>BGV</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectscggi-li><a href=/docs/dialects/cggi/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectscggi><span>CGGI</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsckks-li><a href=/docs/dialects/ckks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsckks><span>CKKS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectscomb-li><a href=/docs/dialects/comb/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectscomb><span>Comb</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsjaxite-li><a href=/docs/dialects/jaxite/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsjaxite><span>Jaxite</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsjaxiteword-li><a href=/docs/dialects/jaxiteword/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsjaxiteword><span>JaxiteWord</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectslattigo-li><a href=/docs/dialects/lattigo/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectslattigo><span>Lattigo</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectslwe-li><a href=/docs/dialects/lwe/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectslwe><span>LWE</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsmgmt-li><a href=/docs/dialects/mgmt/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsmgmt><span>Mgmt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsmodarith-li><a href=/docs/dialects/modarith/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsmodarith><span>ModArith</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsopenfhe-li><a href=/docs/dialects/openfhe/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsopenfhe><span>Openfhe</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectspolynomial-li><a href=/docs/dialects/polynomial/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectspolynomial><span>Polynomial</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsrandom-li><a href=/docs/dialects/random/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsrandom><span>Random</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectsrns-li><a href=/docs/dialects/rns/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectsrns><span>RNS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectssecret-li><a href=/docs/dialects/secret/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectssecret><span>Secret</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstensorext-li><a href=/docs/dialects/tensorext/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstensorext><span>TensorExt</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstfherust-li><a href=/docs/dialects/tfherust/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstfherust><span>TfheRust</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-docsdialectstfherustbool-li><a href=/docs/dialects/tfherustbool/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsdialectstfherustbool><span>TfheRustBool</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docspasses-li><a href=/docs/passes/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docspasses><span class=td-sidebar-nav-active-item>Passes</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-community-li><a href=/community/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-community><span>Community</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-search-li><a href=/search/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-search><span>Search Results</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/google/heir/tree/main/docs/content/en/docs/passes.md class=td-page-meta--view target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/google/heir/edit/main/docs/content/en/docs/passes.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/google/heir/new/main/docs/content/en/docs/passes.md?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/google/heir/issues/new?title=Passes" class=td-page-meta--issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
<a id=print href=https://heir.dev/docs/_print/><i class="fa-solid fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><ul><li><a href=#-add-client-interface><code>-add-client-interface</code></a></li><li><a href=#-annotate-mgmt><code>-annotate-mgmt</code></a></li><li><a href=#-annotate-module><code>-annotate-module</code></a></li><li><a href=#-annotate-secretness><code>-annotate-secretness</code></a></li><li><a href=#-apply-folders><code>-apply-folders</code></a></li><li><a href=#-arith-to-cggi-quart><code>-arith-to-cggi-quart</code></a></li><li><a href=#-arith-to-cggi><code>-arith-to-cggi</code></a></li><li><a href=#-arith-to-mod-arith><code>-arith-to-mod-arith</code></a></li><li><a href=#-bgv-to-lwe><code>-bgv-to-lwe</code></a></li><li><a href=#-cggi-boolean-vectorize><code>-cggi-boolean-vectorize</code></a></li><li><a href=#-cggi-decompose-operations><code>-cggi-decompose-operations</code></a></li><li><a href=#-cggi-set-default-parameters><code>-cggi-set-default-parameters</code></a></li><li><a href=#-cggi-to-jaxite><code>-cggi-to-jaxite</code></a></li><li><a href=#-cggi-to-tfhe-rust-bool><code>-cggi-to-tfhe-rust-bool</code></a></li><li><a href=#-cggi-to-tfhe-rust><code>-cggi-to-tfhe-rust</code></a></li><li><a href=#-ckks-to-lwe><code>-ckks-to-lwe</code></a></li><li><a href=#-collapse-insertion-chains><code>-collapse-insertion-chains</code></a></li><li><a href=#-convert-elementwise-to-affine><code>-convert-elementwise-to-affine</code></a></li><li><a href=#-convert-if-to-select><code>-convert-if-to-select</code></a></li><li><a href=#-convert-polynomial-mul-to-ntt><code>-convert-polynomial-mul-to-ntt</code></a></li><li><a href=#-convert-secret-extract-to-static-extract><code>-convert-secret-extract-to-static-extract</code></a></li><li><a href=#-convert-secret-for-to-static-for><code>-convert-secret-for-to-static-for</code></a></li><li><a href=#-convert-secret-insert-to-static-insert><code>-convert-secret-insert-to-static-insert</code></a></li><li><a href=#-convert-secret-while-to-static-for><code>-convert-secret-while-to-static-for</code></a></li><li><a href=#-convert-tensor-to-scalars><code>-convert-tensor-to-scalars</code></a></li><li><a href=#-convert-to-ciphertext-semantics><code>-convert-to-ciphertext-semantics</code></a></li><li><a href=#-drop-unit-dims><code>-drop-unit-dims</code></a></li><li><a href=#-expand-copy><code>-expand-copy</code></a></li><li><a href=#-extract-loop-body><code>-extract-loop-body</code></a></li><li><a href=#-fold-constant-tensors><code>-fold-constant-tensors</code></a></li><li><a href=#-fold-convert-layout-into-assign-layout><code>-fold-convert-layout-into-assign-layout</code></a></li><li><a href=#-forward-insert-to-extract><code>-forward-insert-to-extract</code></a></li><li><a href=#-forward-store-to-load><code>-forward-store-to-load</code></a></li><li><a href=#-full-loop-unroll><code>-full-loop-unroll</code></a></li><li><a href=#-generate-param-bfv><code>-generate-param-bfv</code></a></li><li><a href=#-generate-param-bgv><code>-generate-param-bgv</code></a></li><li><a href=#-generate-param-ckks><code>-generate-param-ckks</code></a></li><li><a href=#-implement-shift-network><code>-implement-shift-network</code></a></li><li><a href=#-insert-rotate><code>-insert-rotate</code></a></li><li><a href=#-lattigo-alloc-to-inplace><code>-lattigo-alloc-to-inplace</code></a></li><li><a href=#-lattigo-configure-crypto-context><code>-lattigo-configure-crypto-context</code></a></li><li><a href=#-layout-optimization><code>-layout-optimization</code></a></li><li><a href=#-layout-propagation><code>-layout-propagation</code></a></li><li><a href=#-linalg-canonicalizations><code>-linalg-canonicalizations</code></a></li><li><a href=#-lower-polynomial-eval><code>-lower-polynomial-eval</code></a></li><li><a href=#-lower-unpack><code>-lower-unpack</code></a></li><li><a href=#-lwe-add-debug-port><code>-lwe-add-debug-port</code></a></li><li><a href=#-lwe-to-lattigo><code>-lwe-to-lattigo</code></a></li><li><a href=#-lwe-to-openfhe><code>-lwe-to-openfhe</code></a></li><li><a href=#-lwe-to-polynomial><code>-lwe-to-polynomial</code></a></li><li><a href=#-memref-global-replace><code>-memref-global-replace</code></a></li><li><a href=#-mod-arith-to-arith><code>-mod-arith-to-arith</code></a></li><li><a href=#-mod-arith-to-mac><code>-mod-arith-to-mac</code></a></li><li><a href=#-openfhe-configure-crypto-context><code>-openfhe-configure-crypto-context</code></a></li><li><a href=#-openfhe-count-add-and-key-switch><code>-openfhe-count-add-and-key-switch</code></a></li><li><a href=#-operation-balancer><code>-operation-balancer</code></a></li><li><a href=#-optimize-relinearization><code>-optimize-relinearization</code></a></li><li><a href=#-polynomial-approximation><code>-polynomial-approximation</code></a></li><li><a href=#-polynomial-to-mod-arith><code>-polynomial-to-mod-arith</code></a></li><li><a href=#-populate-scale-bgv><code>-populate-scale-bgv</code></a></li><li><a href=#-populate-scale-ckks><code>-populate-scale-ckks</code></a></li><li><a href=#-propagate-annotation><code>-propagate-annotation</code></a></li><li><a href=#-remove-unused-memref><code>-remove-unused-memref</code></a></li><li><a href=#-rotate-and-reduce><code>-rotate-and-reduce</code></a></li><li><a href=#-secret-add-debug-port><code>-secret-add-debug-port</code></a></li><li><a href=#-secret-capture-generic-ambient-scope><code>-secret-capture-generic-ambient-scope</code></a></li><li><a href=#-secret-distribute-generic><code>-secret-distribute-generic</code></a></li><li><a href=#-secret-extract-generic-body><code>-secret-extract-generic-body</code></a></li><li><a href=#-secret-forget-secrets><code>-secret-forget-secrets</code></a></li><li><a href=#-secret-generic-absorb-constants><code>-secret-generic-absorb-constants</code></a></li><li><a href=#-secret-generic-absorb-dealloc><code>-secret-generic-absorb-dealloc</code></a></li><li><a href=#-secret-import-execution-result><code>-secret-import-execution-result</code></a></li><li><a href=#-secret-insert-mgmt-bfv><code>-secret-insert-mgmt-bfv</code></a></li><li><a href=#-secret-insert-mgmt-bgv><code>-secret-insert-mgmt-bgv</code></a></li><li><a href=#-secret-insert-mgmt-ckks><code>-secret-insert-mgmt-ckks</code></a></li><li><a href=#-secret-merge-adjacent-generics><code>-secret-merge-adjacent-generics</code></a></li><li><a href=#-secret-to-bgv><code>-secret-to-bgv</code></a></li><li><a href=#-secret-to-cggi><code>-secret-to-cggi</code></a></li><li><a href=#-secret-to-ckks><code>-secret-to-ckks</code></a></li><li><a href=#-secret-to-mod-arith><code>-secret-to-mod-arith</code></a></li><li><a href=#-secretize><code>-secretize</code></a></li><li><a href=#-select-rewrite><code>-select-rewrite</code></a></li><li><a href=#-shape-inference><code>-shape-inference</code></a></li><li><a href=#-straight-line-vectorize><code>-straight-line-vectorize</code></a></li><li><a href=#-tensor-ext-to-tensor><code>-tensor-ext-to-tensor</code></a></li><li><a href=#-tensor-linalg-to-affine-loops><code>-tensor-linalg-to-affine-loops</code></a></li><li><a href=#-tosa-to-secret-arith><code>-tosa-to-secret-arith</code></a></li><li><a href=#-unroll-and-forward><code>-unroll-and-forward</code></a></li><li><a href=#-validate-noise><code>-validate-noise</code></a></li><li><a href=#-wrap-generic><code>-wrap-generic</code></a></li><li><a href=#-yosys-optimizer><code>-yosys-optimizer</code></a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://heir.dev/docs/>Docs</a></li><li class="breadcrumb-item active" aria-current=page>Passes</li></ol></nav><div class=td-content><h1>Passes</h1><header class=article-meta></header><h3 id=-add-client-interface><code>-add-client-interface</code></h3><p><em>Add client interfaces to secret functions</em></p><p>This pass adds encrypt and decrypt functions for each compiled function in the
IR. These functions maintain the same interface as the original function,
while the compiled function may lose some of this information by the lowerings
to ciphertext types (e.g., a scalar ciphertext, when lowered through RLWE schemes,
must be encoded as a tensor).</p><p>This pass occurs at the secret level, which is necessary because some
backends like the plaintext backend don&rsquo;t actually encrypt, but still require
the ciphertext layout/packing logic to convert cleartexts to plaintexts.</p><h4 id=options>Options</h4><pre tabindex=0><code>-ciphertext-size : Power of two length of the ciphertexts the data is packed in.
</code></pre><h3 id=-annotate-mgmt><code>-annotate-mgmt</code></h3><p><em>Annotate MgmtAttr for secret SSA values in the IR</em></p><p>This pass runs the secretness/level/dimension analysis and annotates the IR with the results,
saving it into each op&rsquo;s attribute dictionary as mgmt.mgmt : <analysis results></p><h4 id=options-1>Options</h4><pre tabindex=0><code>-base-level : Level to start counting from (used by B/FV)
</code></pre><h3 id=-annotate-module><code>-annotate-module</code></h3><p><em>Annotate ModuleOp with Scheme And/Or Backend</em></p><p>This pass annotates the module with a scheme and/or backend.</p><p>This pass should be called before all lowering to enable lowering
to the desired scheme and backend.</p><p>Available scheme:</p><ul><li><code>bgv</code></li><li><code>ckks</code></li><li><code>bfv</code></li><li><code>cggi</code></li></ul><p>Available backend:</p><ul><li><code>openfhe</code></li><li><code>lattigo</code></li></ul><p>Example: <code>--annotate-module="backend=openfhe scheme=ckks"</code></p><pre tabindex=0><code>module attributes {backend.openfhe, scheme.ckks}
  ...
}
</code></pre><h4 id=options-2>Options</h4><pre tabindex=0><code>-scheme  : The scheme to annotate the module with.
-backend : The backend to annotate the module with.
</code></pre><h3 id=-annotate-secretness><code>-annotate-secretness</code></h3><p><em>Annotate secret SSA values in the IR</em></p><p>Debugging helper that runs the secretness analysis and annotates the IR with the results,
extending the <code>{secret.secret}</code> annotation to all operation results that are secret.</p><p>In addition to annotating operation results, the pass also annotates arguments
and return types in <code>func.func</code> operations, as well as any terminators (e.g. <code>return</code>)</p><p>In <code>verbose</code> mode, all results are annotated, including public ones with <code>{secret.public}</code>,
and values for which the secretness analysis is missing are annotated with <code>{secret.missing}</code>,
while values where the secretness analysis is inconclusive are annotated with <code>{secret.unknown}</code>.</p><h4 id=options-3>Options</h4><pre tabindex=0><code>-verbose : If true, annotate secretness state all values, including public ones, and values with missing or inconclusive analysis.
</code></pre><h3 id=-apply-folders><code>-apply-folders</code></h3><p><em>Apply all folding patterns from canonicalize</em></p><p>This pass applies all registered folding patterns greedily to the input IR.
This is useful when running a full canonicalize is too slow, but applying
folders before canonicalize is sufficient to simplify the IR for later
passes, or even sufficient to then subsequently run a full canonicalize pass.</p><p>This is used to prepare an IR for <code>insert-rotate</code> after fully unrolling
loops.</p><h3 id=-arith-to-cggi-quart><code>-arith-to-cggi-quart</code></h3><p><em>Lower <code>arith</code> to <code>cggi</code> dialect and divide each operation into smaller parts.</em></p><p>This pass converts high precision arithmetic operations, i.e. operations on 32 bit integer,
into a sequence of lower precision operations, i.e 8b operations.
Currently, the pass splits the 32b integer into four 8b integers, using the tensor dialect.
These smaller integers are stored in an 16b integer, so that we don&rsquo;t lose the carry information.
This pass converts the <code>arith</code> dialect to the <code>cggi</code> dialect.</p><p>Based on the <code>arith-emulate-wide-int</code> pass from the MLIR arith dialect.</p><p>General assumption: the first element in the tensor is also the LSB element.</p><h3 id=-arith-to-cggi><code>-arith-to-cggi</code></h3><p><em>Lower <code>arith</code> to <code>cggi</code> dialect.</em></p><h3 id=-arith-to-mod-arith><code>-arith-to-mod-arith</code></h3><p><em>Lower standard <code>arith</code> to <code>mod-arith</code>.</em></p><p>This pass lowers the <code>arith</code> dialect to their <code>mod-arith</code> equivalents.</p><p>The arith-to-mod-arith pass is required to lower a neural network TOSA
model to a CGGI backend. This pass will transform the operations to the
mod-arith dialect, where the find-mac pass can be used to convert
consecutive multiply addition operations into a single operation. In a
later pass, these large precision MAC operations (typically
64 or 32-bit) will be lowered into small precision (8 or 4b) operations
that can be mapped to CGGI operations.</p><h4 id=options-4>Options</h4><pre tabindex=0><code>-modulus : Modulus to use for the mod-arith dialect. If not specified, the pass will use the natural modulus for that integer type
</code></pre><h3 id=-bgv-to-lwe><code>-bgv-to-lwe</code></h3><p><em>Lower <code>bgv</code> to <code>lwe</code> dialect.</em></p><p>This pass lowers the <code>bgv</code> dialect to <code>lwe</code> dialect.
Note that some scheme specific ops (e.g., modswitch) that
have no direct analogue in the <code>lwe</code> dialect are left unchanged.
TODO (#1193): support both &ldquo;common&rdquo; and &ldquo;full&rdquo; lwe lowering</p><h3 id=-cggi-boolean-vectorize><code>-cggi-boolean-vectorize</code></h3><p><em>Group different logic gates with the packed API</em></p><p>This pass groups independent logic gates into a single call of the packed
operations. Pass is based on the straight-line-vectorizer, but is fundamentally different.
This pass combines any type of boolean gates and is not restricted to combining the same type of gate operand.</p><p>Pass is intended for the <code>FPT</code> tfhe-rs API, where <code>packed_gates</code> function get a
the boolean gates are passed as a string vector and a left and right vector of ciphertexts.
Each boolean gates specified in <code>gates</code> is then applied element wise.</p><pre tabindex=0><code>let outputs_ct = fpga_key.packed_gates(&amp;gates, &amp;ref_to_ct_lefts, &amp;ref_to_ct_rights);
</code></pre><h4 id=options-5>Options</h4><pre tabindex=0><code>-parallelism : Parallelism factor for batching. 0 is infinite parallelism
</code></pre><h3 id=-cggi-decompose-operations><code>-cggi-decompose-operations</code></h3><p><em>Expands CGGI operations into LWE operations and programmable bootstraps</em></p><p>This pass expands high level CGGI operations (e.g. LUT2, XOR, etc.).</p><p>If the option <code>expand-lincomb</code> is set, the expansion will continue into the
component LWE scalar operations and a programmable bootstrap operation.
Otherwise, the expansion will be stop at the <code>cggi.lut_lincomb</code> level. By
default, <code>expand-lincomb</code> is true.</p><p>For example, a LUT3 operation is composed of three LWE ciphertext inputs $c,
b, a$ (in MSB to LSB ordering) which must be combined via the linear
combination $4 * c + 2 * b + a$ before being fed into a programmable
bootstrap defined by the lookup table.</p><p>This pass supports XOR, LUT2, LUT3, and LutLincomb operations.</p><h4 id=options-6>Options</h4><pre tabindex=0><code>-expand-lincomb : Expand lincomb operations to the PBS and scalar level
</code></pre><h3 id=-cggi-set-default-parameters><code>-cggi-set-default-parameters</code></h3><p><em>Set default parameters for CGGI ops</em></p><p>This pass adds default parameters to all CGGI ops as <code>cggi_params</code> named
attributes, overriding any existing attribute set with that name.</p><p>This pass is primarily for testing purposes, and as a parameter provider
before a proper parameter selection mechanism is added. This pass should not
be used in production.</p><p>The specific parameters are hard-coded in
<code>lib/Dialect/CGGI/Transforms/SetDefaultParameters.cpp</code>.</p><h3 id=-cggi-to-jaxite><code>-cggi-to-jaxite</code></h3><p><em>Lower <code>cggi</code> to <code>jaxite</code> dialect.</em></p><h3 id=-cggi-to-tfhe-rust-bool><code>-cggi-to-tfhe-rust-bool</code></h3><p><em>Lower <code>cggi</code> to <code>tfhe_rust_bool</code> dialect.</em></p><h3 id=-cggi-to-tfhe-rust><code>-cggi-to-tfhe-rust</code></h3><p><em>Lower <code>cggi</code> to <code>tfhe_rust</code> dialect.</em></p><h3 id=-ckks-to-lwe><code>-ckks-to-lwe</code></h3><p><em>Lower <code>ckks</code> to <code>lwe</code> dialect.</em></p><p>This pass lowers the <code>ckks</code> dialect to <code>lwe</code> dialect.
Note that some scheme specific ops (e.g., rescale) that
have no direct analogue in the <code>lwe</code> dialect are left unchanged.
TODO (#1193): support both &ldquo;common&rdquo; and &ldquo;full&rdquo; lwe lowering</p><h3 id=-collapse-insertion-chains><code>-collapse-insertion-chains</code></h3><p><em>Collapse chains of extract/insert ops into rotate ops when possible</em></p><p>This pass is a cleanup pass for <code>insert-rotate</code>. That pass sometimes leaves
behind a chain of insertion operations like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%14</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c5</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%inserted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>insert <span style=color:#000>%extracted</span> into <span style=color:#000>%dest</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%extracted_0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%14</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c6</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%inserted_1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>insert <span style=color:#000>%extracted_0</span> into <span style=color:#000>%inserted</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c1</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%extracted_2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%14</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c7</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%inserted_3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>insert <span style=color:#000>%extracted_2</span> into <span style=color:#000>%inserted_1</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>%extracted_28</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%14</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%inserted_29</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>insert <span style=color:#000>%extracted_28</span> into <span style=color:#000>%inserted_27</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c15</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>yield <span style=color:#000>%inserted_29</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>In many cases, this chain will insert into every index of the <code>dest</code> tensor,
and the extracted values all come from consistently aligned indices of the same
source tensor. In this case, the chain can be collapsed into a single <code>rotate</code>.</p><p>Each index used for insertion or extraction must be constant; this may
require running <code>--canonicalize</code> or <code>--sccp</code> before this pass to apply
folding rules (use <code>--sccp</code> if you need to fold constant through control flow).</p><h3 id=-convert-elementwise-to-affine><code>-convert-elementwise-to-affine</code></h3><p><em>This pass lowers ElementwiseMappable operations to Affine loops.</em></p><p>This pass lowers ElementwiseMappable operations over tensors
to affine loop nests that instead apply the operation to the underlying scalar values.</p><p>Usage:
&lsquo;&ndash;convert-elementwise-to-affine=convert-ops=arith.mulf '
restrict conversion to mulf op from arith dialect.</p><p>&lsquo;&ndash;convert-elementwise-to-affine=convert-ops=arith.addf,arith.divf convert-dialects=bgv&rsquo;
restrict conversion to addf and divf ops from arith dialect and all of the ops in bgv dialect.</p><p>&ndash;convert-elementwise-to-affine=convert-dialects=arith
restrict conversion to arith dialect so ops only from arith dialect is processed.</p><p>&ndash;convert-elementwise-to-affine=convert-ops=arith.addf,arith.mulf
restrict conversion only to these two ops - addf and mulf - from arith dialect.</p><h4 id=options-7>Options</h4><pre tabindex=0><code>-convert-ops      : comma-separated list of ops to run this pass on 
-convert-dialects : comma-separated list of dialects to run this pass on 
</code></pre><h3 id=-convert-if-to-select><code>-convert-if-to-select</code></h3><p><em>Convert scf.if operations on secret conditions to arith.select operations.</em></p><p>Conversion for If-operations that evaluate secret condition to alternative select operations.</p><h3 id=-convert-polynomial-mul-to-ntt><code>-convert-polynomial-mul-to-ntt</code></h3><p><em>Rewrites polynomial operations to their NTT equivalents</em></p><p>Applies a rewrite pattern to convert polynomial multiplication to the
equivalent using the number-theoretic transforms (NTT) when possible.</p><p>Polynomial multiplication can be rewritten as polynomial.NTT
on each operand, followed by modulo elementwise multiplication of the
point-value representation and then the inverse-NTT back to coefficient
representation.</p><h3 id=-convert-secret-extract-to-static-extract><code>-convert-secret-extract-to-static-extract</code></h3><p><em>Convert <code>tensor.extract</code> operations on secret index to static extract operations.</em></p><p>Converts <code>tensor.extract</code> operations that read value at secret index to alternative static <code>tensor.extract</code> operations that extracts value at each index and conditionally selects the value extracted at the secret index.</p><p>Note: Running this pass alone does not result in a data-oblivious program; we have to run the <code>--convert-if-to-select</code> pass to the resulting program to convert the secret-dependent If-operation to a Select-operation.</p><p>Example input:
<code>mlir func.func @main(%secretTensor: !secret.secret&lt;tensor&lt;32xi16>>, %secretIndex: !secret.secret&lt;index>)) -> !secret.secret&lt;i16> { ... %0 = secret.generic(%secretTensor, %secretIndex : !secret.secret&lt;tensor&lt;32xi16>>, !secret.secret&lt;index>) { ^bb0(%tensor: tensor&lt;32xi16>, %index: index): // Violation: tensor.extract loads value at secret index %extractedValue = tensor.extract %tensor[%index] : tensor&lt;16xi32> ... }</code></p><pre><code>Output:
```mlir
func.func @main(%secretTensor: !secret.secret&lt;tensor&lt;32xi16&gt;&gt;, %secretIndex: !secret.secret&lt;index&gt;)) -&gt; !secret.secret&lt;i16&gt; {
  ...
  %0 = secret.generic(%secretTensor, %secretIndex : !secret.secret&lt;tensor&lt;32xi16&gt;&gt;, !secret.secret&lt;index&gt;) {
  ^bb0(%tensor: tensor&lt;32xi16&gt;, %index: index):
    %extractedValue = affine.for %i=0 to 16 iter_args(%arg= %dummyValue) -&gt; (i32) {
      // 1. Check if %i matches %index
      %cond = arith.cmpi eq, %i, %index : index
      // 2. Extract value at %i
      %value = tensor.extract %tensor[%i] : tensor&lt;16xi32&gt;
      // 3. If %i matches %index, yield %value extracted in (2), else yield %dummyValue
      %result = scf.if %cond -&gt; (i32) {
        scf.yield %value : i32
      } else{
        scf.yield %arg : i32
      }
      // 4. Yield result from (3)
      affine.yield %result : i32
</code></pre><p>}
&mldr;
}</p><pre><code>```
</code></pre><h3 id=-convert-secret-for-to-static-for><code>-convert-secret-for-to-static-for</code></h3><p><em>Convert secret scf.for ops to affine.for ops with constant bounds.</em></p><p>Conversion for For-operation that evaluate secret bound(s) to alternative affine For-operation with constant bound(s).</p><p>It replaces data-dependent bounds with an If-operation to check the bounds, and conditionally execute and yield values from the For-operation&rsquo;s body.
Note: Running this pass alone does not result in a data-oblivious program; we have to run the <code>--convert-if-to-select</code> pass to the resulting program to convert the secret-dependent If-operation to a Select-operation.</p><p>Example input:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretTensor</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000>%secretLower</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%secretUpper</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>   <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretTensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%secretLower</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%secretUpper</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;){</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%lower</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%upper</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span> <span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> scf<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%i</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%lower</span> to <span style=color:#000>%upper</span> step <span style=color:#000>%step</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%val</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%input</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%sum</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%extracted</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>        scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%sum</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>lower =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>upper =</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretTensor</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000>%secretIndex</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>   <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretTensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%secretLower</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%secretUpper</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;){</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%lower</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%upper</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span> <span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%i</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>16</span> step <span style=color:#000>%step</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%val</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%lowerCond</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi sge<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%index</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%upperCond</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi slt<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%index</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%cond</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>andi <span style=color:#000>%lowerCond</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%upperCond</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%result</span> <span style=color:#000;font-weight:700>=</span> scf<span style=color:#000;font-weight:700>.</span>if<span style=color:#000;font-weight:700>(</span><span style=color:#000>%cond</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%input</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>%sum</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%extracted</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>          scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%sum</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> else <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%arg</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        affine<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%result</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>lower =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>upper =</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><h3 id=-convert-secret-insert-to-static-insert><code>-convert-secret-insert-to-static-insert</code></h3><p><em>Convert <code>tensor.insert</code> operations on secret index to static insert operations.</em></p><p>Converts <code>tensor.insert</code> operations that write to secret index to alternative static <code>tensor.insert</code> operations that inserts the inserted value at each index and conditionally selects the newly produced tensor that contains the value at the secret index.</p><p>Note: Running this pass alone does not result in a data-oblivious program; we have to run the <code>--convert-if-to-select</code> pass to the resulting program to convert the secret-dependent If-operation to a Select-operation.</p><p>Example input:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretTensor</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000>%secretIndex</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;))</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretTensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%secretIndex</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%index</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Violation: tensor.insert writes value at secret index
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>%inserted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>insert <span style=color:#000>%newValue</span> into <span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%index</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretTensor</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000>%secretIndex</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;))</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretTensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%secretIndex</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%index</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%inserted</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%i</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>16</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%inputArg</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// 1. Check if %i matches the %index
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>%cond</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi eq<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%index</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// 2. Insert %newValue and produce %newTensor
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>%newTensor</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>insert <span style=color:#000>%value</span> into <span style=color:#000>%inputArg</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// 3. If %i matches %inputIndex, yield %newTensor, else yield unchanged input tensor
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>%finalTensor</span> <span style=color:#000;font-weight:700>=</span> scf<span style=color:#000;font-weight:700>.</span>if <span style=color:#000>%cond</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%newTensor</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span> else<span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%inputArg</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// 4. Yield final tensor
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      affine<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%finalTensor</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=-convert-secret-while-to-static-for><code>-convert-secret-while-to-static-for</code></h3><p><em>Convert secret scf.while ops to affine.for ops that have constant bounds.</em></p><p>Convert scf.while with a secret condition to affine.for with constant bounds. It replaces the scf.condition operation found in the scf.while loop with an scf.if operation that conditionally executes operations in the while operation&rsquo;s body and yields values.</p><p>A &ldquo;max_iter&rdquo; attribute should be specified as part of the secret-dependent scf.while operation to successfully transform to a secret-independent affine.for operation. This attribute determines the maximum number of iterations for the new affine.for operation.</p><p>Note: Running this pass alone does not result in a data-oblivious program; we have to run the <code>--convert-if-to-select</code> pass to the resulting program to convert the secret-dependent If-operation to a Select-operation.</p><p>Example input:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// C-like code
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>int main<span style=color:#000;font-weight:700>(</span>int secretInput<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  while <span style=color:#000;font-weight:700>(</span>secretInput <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>secretInput =</span> secretInput <span style=color:#000;font-weight:700>*</span> secretInput<span style=color:#a40000>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> secretInput<span style=color:#a40000>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// MLIR
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretInput</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c100</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>100</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretInput</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> scf<span style=color:#000;font-weight:700>.</span>while <span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%input</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi sgt<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c100</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      scf<span style=color:#000;font-weight:700>.</span>condition<span style=color:#000;font-weight:700>(</span><span style=color:#000>%2</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> do <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> attributes <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>max_iter =</span> <span style=color:#0000cf;font-weight:700>16</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretInput</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c100</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>100</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%secretInput</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>16</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%input</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi sgt<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c100</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> scf<span style=color:#000;font-weight:700>.</span>if <span style=color:#000;font-weight:700>(</span><span style=color:#000>%2</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>        scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span> else <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>      affine<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> attributes <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>max_iter =</span> <span style=color:#0000cf;font-weight:700>16</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=-convert-tensor-to-scalars><code>-convert-tensor-to-scalars</code></h3><p><em>Effectively &lsquo;unrolls&rsquo; tensors of static shape to scalars.</em></p><p>This pass will convert a static-shaped tensor type to a TypeRange
containing product(dim) copies of the element type of the tensor.
This pass currently includes two patterns:</p><ol><li>It converts tensor.from_elements operations to
the corresponding scalar inputs.</li><li>It converts tensor.insert operations by updating the
ValueRange corresponding to the converted input and
updating it with the scalar to be inserted.</li></ol><p>It also applies folders greedily to simplify, e.g., extract(from_elements).</p><p>Note: The pass is designed to be run on an IR, where the only operations
with tensor typed operands are tensor &ldquo;management&rdquo; operations such as insert/extract,
with all other operations (e.g., arith operations) already taking (extracted) scalar inputs.
For example, an IR where elementwise operations have been converted to scalar operations via
<code>--convert-elementwise-to-affine</code>.</p><p>The pass might insert new tensor.from_elements operations or manually create the scalar ValueRange
via inserting tensor.extract operations if any operations remain that operate on tensors.
The pass currently applies irrespective of tensor size, i.e., might be very slow for large tensors.</p><p>TODO (#1023): Extend this pass to support more tensor operations, e.g., <code>tensor.slice</code></p><h4 id=options-8>Options</h4><pre tabindex=0><code>-max-size : Limits `unrolling` to tensors with at most max-size elements
</code></pre><h3 id=-convert-to-ciphertext-semantics><code>-convert-to-ciphertext-semantics</code></h3><p><em>Converts programs with tensor semantics to ciphertext semantics</em></p><p>This pass performs two inherently intertwined transformations:</p><ol><li>Convert a program from tensor semantics to ciphertext semantics, explained below.</li><li>Implement ops defined on tensor-semantic types in terms of ops defined on
ciphertext-semantic types.</li></ol><p>A program is defined to have <em>tensor semantics</em> if the tensor-typed values
are manipulated according to standard MLIR tensor operations and semantics.</p><p>A program is defined to have <em>ciphertext semantics</em> if the tensor-typed
values correspond to tensors of FHE ciphertexts, where the last dimension of
the tensor type is the number of ciphertext slots.</p><p>For example, a tensor of type <code>tensor&lt;32x32xi16></code> with tensor semantics might
be converted by this pass, depending on the pass options, to a single
ciphertext-semantics <code>tensor&lt;65536xi16></code>. A larger tensor might, depending on
the layout chosen by earlier passes, be converted to a <code>tensor&lt;4x32768xi16></code>,
where the trailing dimension corresponds to the number of slots in the
ciphertext.</p><p>Tensors with ciphertext semantics can be thought of as an intermediate step
between lowering from tensor types with tensor semantics to concrete <code>lwe</code>
dialect ciphertext types in a particular FHE scheme. Having this intermediate
step is useful because some optimizations are easier to implement, and can be
implemented more generically, in the abstract FHE computational model
where the data types are large tensors, and the operations are SIMD additions,
multiplications, and cyclic rotations.</p><p>Function arguments and return values are annotated with the original tensor
type in the <code>secret.original_type</code> attribute. This enables later lowerings
to implement appropriate encoding and decoding routines for FHE schemes.</p><p>The second role of this pass is to implement FHE kernels for various high-level
tensor operations, such as <code>linalg.matvec</code>. This must happen at the same time
as the type conversion because the high-level ops like <code>linalg.matvec</code> are
not well-defined on ciphertext-semantic tensors, while their implementation
as SIMD/rotation ops are not well-defined on tensor-semantic tensors.</p><p>TODO(#1541): provide example docs</p><h4 id=options-9>Options</h4><pre tabindex=0><code>-ciphertext-size : Power of two length of the ciphertexts the data is packed in.
</code></pre><h3 id=-drop-unit-dims><code>-drop-unit-dims</code></h3><p><em>Drops unit dimensions from linalg ops.</em></p><p>This pass converts <code>linalg</code> whose operands have unit dimensions
in their types to specialized ops that drop these unit dimensions.</p><p>For example, a <code>linalg.matmul</code> whose RHS has type <code>tensor&lt;32x1xi32></code> is
converted to a <code>linalg.matvec</code> op on the underlying <code>tensor&lt;32xi32></code>.</p><h3 id=-expand-copy><code>-expand-copy</code></h3><p><em>Expands memref.copy ops to explicit affine loads and stores</em></p><p>This pass removes memref copy operations by expanding them to affine loads
and stores. This pass introduces affine loops over the dimensions of the
MemRef, so must be run prior to any affine loop unrolling in a pipeline.</p><p>Input</p><pre tabindex=0><code>module {
  func.func @memref_copy() {
    %alloc = memref.alloc() : memref&lt;2x3xi32&gt;
    %alloc_0 = memref.alloc() : memref&lt;2x3xi32&gt;
    memref.copy %alloc, %alloc_0 : memref&lt;1x1xi32&gt; to memref&lt;1x1xi32&gt;
  }
}
</code></pre><p>Output</p><pre tabindex=0><code>module {
  func.func @memref_copy() {
    %alloc = memref.alloc() : memref&lt;2x3xi32&gt;
    %alloc_0 = memref.alloc() : memref&lt;2x3xi32&gt;
    affine.for %arg0 = 0 to 2 {
      affine.for %arg1 = 0 to 3 {
        %1 = affine.load %alloc[%arg0, %arg1] : memref&lt;2x3xi32&gt;
        affine.store %1, %alloc_0[%arg0, %arg1] : memref&lt;2x3xi32&gt;
      }
    }
  }
}
</code></pre><p>When <code>--disable-affine-loop=true</code> is set, then the output becomes</p><pre tabindex=0><code>module {
  func.func @memref_copy() {
    %alloc = memref.alloc() : memref&lt;2x3xi32&gt;
    %alloc_0 = memref.alloc() : memref&lt;2x3xi32&gt;
    %c0 = arith.constant 0 : index
    %c1 = arith.constant 1 : index
    %c2 = arith.constant 2 : index
    %0 = affine.load %alloc[%c0, %c0] : memref&lt;2x3xi32&gt;
    affine.store %0, %alloc_0[%c0, %c0] : memref&lt;2x3xi32&gt;
    %1 = affine.load %alloc[%c0, %c1] : memref&lt;2x3xi32&gt;
    affine.store %1, %alloc_0[%c0, %c1] : memref&lt;2x3xi32&gt;
    %2 = affine.load %alloc[%c0, %c2] : memref&lt;2x3xi32&gt;
    affine.store %2, %alloc_0[%c0, %c2] : memref&lt;2x3xi32&gt;
    [...]
  }
}
</code></pre><h4 id=options-10>Options</h4><pre tabindex=0><code>-disable-affine-loop : Use this to control to disable using affine loops
</code></pre><h3 id=-extract-loop-body><code>-extract-loop-body</code></h3><p><em>Extracts logic of a loop bodies into functions.</em></p><p>This pass extracts logic in the inner body of for loops into functions.</p><p>This pass requires that tensors are lowered to memref. It expects that a
loop body contains a number of affine.load statements used as inputs to the
extracted function, and a single affine.store used as the extracted
function&rsquo;s output.</p><p>Input</p><pre tabindex=0><code>module {
  func.func @loop_body() {
    %c-128_i8 = arith.constant -128 : i8
    %c127_i8 = arith.constant 127 : i8
    %alloc_7 = memref.alloc() {alignment = 64 : i64} : memref&lt;25x20x8xi8&gt;
    affine.for %arg1 = 0 to 25 {
      affine.for %arg2 = 0 to 20 {
        affine.for %arg3 = 0 to 8 {
          %98 = affine.load %alloc_6[%arg1, %arg2, %arg3] : memref&lt;25x20x8xi8&gt;
          %99 = arith.cmpi slt, %arg0, %c-128_i8 : i8
          %100 = arith.select %99, %c-128_i8, %arg0 : i8
          %101 = arith.cmpi sgt, %arg0, %c127_i8 : i8
          %102 = arith.select %101, %c127_i8, %100 : i8
          affine.store %102, %alloc_7[%arg1, %arg2, %arg3] : memref&lt;25x20x8xi8&gt;
        }
      }
    }
  }
}
</code></pre><p>Output</p><pre tabindex=0><code>module {
  func.func @loop_body() {
    %alloc_7 = memref.alloc() {alignment = 64 : i64} : memref&lt;25x20x8xi8&gt;
    affine.for %arg1 = 0 to 25 {
      affine.for %arg2 = 0 to 20 {
        affine.for %arg3 = 0 to 8 {
          %98 = affine.load %alloc_6[%arg1, %arg2, %arg3] : memref&lt;25x20x8xi8&gt;
          %102 = func.call @__for_loop(%98) : (i8) -&gt; i8
          affine.store %102, %alloc_7[%arg1, %arg2, %arg3] : memref&lt;25x20x8xi8&gt;
        }
      }
    }
  }
  func.func private @__for_loop(%arg0: i8) -&gt; i8 {
    %c-128_i8 = arith.constant -128 : i8
    %c127_i8 = arith.constant 127 : i8
    %99 = arith.cmpi slt, %arg0, %c-128_i8 : i8
    %100 = arith.select %99, %c-128_i8, %arg0 : i8
    %101 = arith.cmpi sgt, %arg0, %c127_i8 : i8
    %102 = arith.select %101, %c127_i8, %100 : i8
    return %102 : i8
  }
}
</code></pre><h4 id=options-11>Options</h4><pre tabindex=0><code>-min-loop-size : Use this to control the minimum loop size to apply this pass
-min-body-size : Use this to control the minimum loop body size to apply this pass
</code></pre><h3 id=-fold-constant-tensors><code>-fold-constant-tensors</code></h3><p><em>This pass folds any constant tensors.</em></p><p>This pass folds tensor operations on constants to new constants.</p><p>The following folders are supported:</p><ul><li><code>tensor.insert</code> of a constant tensor</li><li><code>tensor.collapse_shape</code> of a constant tensor</li></ul><h3 id=-fold-convert-layout-into-assign-layout><code>-fold-convert-layout-into-assign-layout</code></h3><p><em>Merges tensor_ext.convert_layout ops into preceding tensor_ext.assign_layout ops</em></p><p>A <code>tensor_ext.assign_layout</code> op corresponds to an encoding of a cleartext
into a plaintext or ciphertext. If this is immediately followed by a
<code>tensor_ext.convert_layout</code> op, then one can just change the initial encoding
to correspond to the result of the conversion.</p><p>If the result of an <code>assign_layout</code> has multiple subsequent <code>convert_layout</code>
ops, then they are folded into multiple <code>assign_layout</code> ops applied to the
same cleartext.</p><h3 id=-forward-insert-to-extract><code>-forward-insert-to-extract</code></h3><p><em>Forward inserts to extracts within a single block</em></p><p>This pass is similar to forward-store-to-load pass where store ops
are forwarded load ops; here instead tensor.insert ops are forwarded
to tensor.extract ops.</p><p>Does not support complex control flow within a block, nor ops with
arbitrary subregions.</p><h3 id=-forward-store-to-load><code>-forward-store-to-load</code></h3><p><em>Forward stores to loads within a single block</em></p><p>This pass is a simplified version of mem2reg and similar passes.
It analyzes an operation, finding all basic blocks within that op
that have memrefs whose stores can be forwarded to loads.</p><p>Does not support complex control flow within a block, nor ops
with arbitrary subregions.</p><h3 id=-full-loop-unroll><code>-full-loop-unroll</code></h3><p><em>Fully unroll all loops</em></p><p>Scan the IR for affine.for loops and unroll them all.</p><h3 id=-generate-param-bfv><code>-generate-param-bfv</code></h3><p><em>Generate BFV Scheme Parameter</em></p><p>The pass generates the BFV scheme parameter using a given noise model.</p><p>There are three noise models available:</p><ul><li><code>bfv-noise-by-bound-coeff-average-case</code></li><li><code>bfv-noise-by-bound-coeff-worst-case</code> or <code>bfv-noise-kpz21</code></li><li><code>bfv-noise-by-variance-coeff</code> or <code>bfv-noise-bmcm23</code></li></ul><p>To use public-key encryption/secret-key encryption in the model, the option
<code>usePublicKey</code> could be set accordingly.</p><p>The first two models are taken from KPZ21, and they work by bounding
the coefficient embedding of the ciphertexts. The difference
of the two models is expansion factor used for multiplication
of the coefficients, the first being $2 \sqrt{N}$ and the second
being $N$.</p><p>The third model is taken from BMCM23. It works by tracking the variance
of the coefficient embedding of the ciphertexts. This gives a much tighter
noise estimate for independent ciphertext input, but may give underestimation
for dependent ciphertext input. See <a href=https://ia.cr/2023/600>the paper</a> for more details.</p><p>This pass then generates the moduli chain consisting of primes
of bits specified by the <code>mod-bits</code> field.</p><p>Usually for B/FV <code>mod-bits</code> is set to 60. But when machine word size is
small, users may also want to set it to 57.</p><p>This pass relies on the presence of the <code>mgmt</code> dialect ops to model
relinearize, and it relies on <code>mgmt.mgmt</code> attribute to determine
the ciphertext level/dimension. These ops and attributes can be added by
a pass like <code>--secret-insert-mgmt-bgv</code> and <code>--annotate-mgmt</code>.</p><p>User can provide custom scheme parameters by annotating bgv::SchemeParamAttr
at the module level. Note that we reuse bgv::SchemeParamAttr for BFV.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>module <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#f57900>attrs =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>arg0 =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;}}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^body</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%input0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>After applying the pass, the module will be updated with the scheme parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>module attributes <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>bgv.schemeParam =</span> <span style=color:#000>#bgv.scheme_param</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>logN =</span> <span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>Q =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1152921504606994433</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>P =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1152921504607191041</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>plaintextModulus =</span> <span style=color:#0000cf;font-weight:700>65537</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// same as above
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=options-12>Options</h4><pre tabindex=0><code>-model                         : Noise model to validate against.
-mod-bits                      : Default number of bits for all prime coefficient modulusto use for the ciphertext space.
-slot-number                   : Minimum number of slots for parameter generation.
-plaintext-modulus             : Plaintext modulus.
-use-public-key                : If true, uses a public key for encryption.
-encryption-technique-extended : If true, uses EXTENDED encryption technique for encryption. (See https://ia.cr/2022/915)
</code></pre><h3 id=-generate-param-bgv><code>-generate-param-bgv</code></h3><p><em>Generate BGV Scheme Parameter using a given noise model</em></p><p>The pass generates the BGV scheme parameter using a given noise model.</p><p>There are four noise models available:</p><ul><li><code>bgv-noise-by-bound-coeff-average-case</code> or <code>bgv-noise-kpz21</code></li><li><code>bgv-noise-by-bound-coeff-worst-case</code></li><li><code>bgv-noise-by-variance-coeff</code> or <code>bgv-noise-mp24</code></li><li><code>bgv-noise-mono</code></li></ul><p>To use public-key encryption/secret-key encryption in the model, the option
<code>usePublicKey</code> could be set accordingly.</p><p>The first two models are taken from KPZ21, and they work by bounding
the coefficient embedding of the ciphertexts. The difference
of the two models is expansion factor used for multiplication
of the coefficients, the first being $2 \sqrt{N}$ and the second
being $N$.</p><p>The third model is taken from MP24. It works by tracking the variance
of the coefficient embedding of the ciphertexts. This gives a more accurate
noise estimate, but it may give underestimates in some cases. See the paper
for more details.</p><p>The last model is taken from MMLGA22. It uses the canonical embedding to
bound the critical quantity of a ciphertext that defines whether c can be
decrypted correctly. According to the authors they achieve more accurate and
better bounds than KPZ21. See the paper for more details.</p><p>This pass relies on the presence of the <code>mgmt</code> dialect ops to model
relinearize/modreduce, and it relies on <code>mgmt.mgmt</code> attribute to determine
the ciphertext level/dimension. These ops and attributes can be added by
a pass like <code>--secret-insert-mgmt-bgv</code> and <code>--annotate-mgmt</code>.</p><p>User can provide custom scheme parameters by annotating bgv::SchemeParamAttr
at the module level.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>module <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#f57900>attrs =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>arg0 =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;}}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^body</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%input0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>After applying the pass, the module will be updated with the scheme parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>module attributes <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>bgv.schemeParam =</span> <span style=color:#000>#bgv.scheme_param</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>logN =</span> <span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>Q =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>4294991873</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>P =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>4295049217</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>plaintextModulus =</span> <span style=color:#0000cf;font-weight:700>65537</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// same as above
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=options-13>Options</h4><pre tabindex=0><code>-model                         : Noise model to validate against.
-plaintext-modulus             : Plaintext modulus.
-slot-number                   : Minimum number of slots for parameter generation.
-use-public-key                : If true, uses a public key for encryption.
-encryption-technique-extended : If true, uses EXTENDED encryption technique for encryption. (See https://ia.cr/2022/915)
</code></pre><h3 id=-generate-param-ckks><code>-generate-param-ckks</code></h3><p><em>Generate CKKS Scheme Parameter</em></p><p>The pass generates the CKKS scheme parameter.</p><p>The pass asks the user to provide the number of bits for the first modulus
and scaling modulus. The default values are 55 and 45, respectively.
Then the pass generates the moduli chain using the provided values.</p><p>This pass relies on the presence of the <code>mgmt</code> dialect ops to model
relinearize/modreduce, and it relies on <code>mgmt.mgmt</code> attribute to determine
the ciphertext level/dimension. These ops and attributes can be added by
a pass like <code>--secret-insert-mgmt-&lt;scheme></code> and <code>--annotate-mgmt</code>.</p><p>User can provide custom scheme parameters by annotating bgv::SchemeParamAttr
at the module level.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>module <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#f57900>attrs =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>arg0 =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;}}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^body</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addf <span style=color:#000>%input0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f16</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f16</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>After applying the pass, the module will be updated with the scheme parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>module attributes <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>ckks.schemeParam =</span> <span style=color:#000>#ckks.scheme_param</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>logN =</span> <span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>Q =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>36028797019389953</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>P =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>36028797019488257</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>logDefaultScale =</span> <span style=color:#0000cf;font-weight:700>45</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// same as above
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=options-14>Options</h4><pre tabindex=0><code>-slot-number                   : Minimum number of slots for parameter generation.
-first-mod-bits                : Default number of bits of the first prime coefficient modulus to use for the ciphertext space.
-scaling-mod-bits              : Default number of bits of the scaling prime coefficient modulus to use for the ciphertext space.
-use-public-key                : If true, uses a public key for encryption.
-encryption-technique-extended : If true, uses EXTENDED encryption technique for encryption. (See https://ia.cr/2022/915)
</code></pre><h3 id=-implement-shift-network><code>-implement-shift-network</code></h3><p><em>Implement tensor_ext.convert_layout ops as shift newtorks</em></p><p>This pass converts <code>tensor_ext.permute</code> ops into a network of
<code>tensor_ext.rotate</code> ops, aiming to minimize the overall latency of the
permutation.</p><p>The input IR must have tensors that correspond to plaintexts or
ciphertexts.</p><p>The method uses graph coloring, an approach based on Vos-Vos-Erkin 2022,
<a href=https://link.springer.com/chapter/10.1007/978-3-031-17140-6_20>&ldquo;Efficient Circuits for Permuting and Mapping Packed Values Across
Leveled Homomorphic Ciphertexts&rdquo;</a>.</p><p>Example, Figure 3 from the paper above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Provide an explicit permutation, though an affine_map can also be used.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>#map</span> <span style=color:#000;font-weight:700>=</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>14</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@figure3</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>permute <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>permutation =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Then running <code>--implement-shift-network=ciphertext-size=16</code> produces
a shift network composed of plaintext-ciphertext masks (<code>arith.constant</code> + <code>arith.muli</code>)
followed by rotations and additions. The Vos-Vos-Erkin method splits the work
into multiple independent groups that are added together at the end.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@figure3</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c1_i32</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1_i32</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c2_i32</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2_i32</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c4_i32</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c4_i32</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c8_i32</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%9</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%8</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c8_i32</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%10</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%9</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%11</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c1_i32_4</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%12</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%11</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1_i32_4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_5</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%13</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_5</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c2_i32_6</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%14</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%13</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2_i32_6</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%15</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%12</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%14</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_7</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%16</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_7</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c4_i32_8</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%17</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%16</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c4_i32_8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%18</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%15</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%17</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_9</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%19</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_9</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c8_i32_10</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%20</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%19</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c8_i32_10</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%21</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%18</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%20</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%22</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%10</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%21</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_11</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%23</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_11</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c1_i32_12</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%24</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%23</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1_i32_12</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_13</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%25</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_13</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c2_i32_14</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%26</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%25</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2_i32_14</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%27</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%24</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%26</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_15</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%28</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_15</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c4_i32_16</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%29</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%28</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c4_i32_16</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%30</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%27</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%29</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%cst_17</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%31</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst_17</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c8_i32_18</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%32</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%31</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c8_i32_18</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%33</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%30</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%32</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%34</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%22</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%33</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%34</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=options-15>Options</h4><pre tabindex=0><code>-ciphertext-size : Power of two length of the ciphertexts the data is packed in.
</code></pre><h3 id=-insert-rotate><code>-insert-rotate</code></h3><p><em>Vectorize arithmetic FHE operations using HECO-style heuristics</em></p><p>This pass implements the SIMD-vectorization passes from the
<a href=https://arxiv.org/abs/2202.01649>HECO paper</a>.</p><p>The pass operates by identifying arithmetic operations that can be suitably
combined into a combination of cyclic rotations and vectorized operations
on tensors. It further identifies a suitable &ldquo;slot target&rdquo; for each operation
and heuristically aligns the operations to reduce unnecessary rotations.</p><p>This pass by itself does not eliminate any operations, but instead inserts
well-chosen rotations so that, for well-structured code (like unrolled affine loops),
a subsequent <code>--cse</code> and <code>--canonicalize</code> pass will dramatically reduce the IR.
As such, the pass is designed to be paired with the canonicalization patterns
in <code>tensor_ext</code>, as well as the <code>collapse-insertion-chains</code> pass, which
cleans up remaining insertion and extraction ops after the main simplifications
are applied.</p><p>Unlike HECO, this pass operates on plaintext types and tensors, along with
the HEIR-specific <code>tensor_ext</code> dialect for its cyclic <code>rotate</code> op. It is intended
to be run before lowering to a scheme dialect like <code>bgv</code>.</p><h3 id=-lattigo-alloc-to-inplace><code>-lattigo-alloc-to-inplace</code></h3><p><em>Convert AllocOps to InplaceOps in Lattigo</em></p><p>This pass converts AllocOps to InplaceOps in Lattigo.</p><h3 id=-lattigo-configure-crypto-context><code>-lattigo-configure-crypto-context</code></h3><p><em>Configure the crypto context in Lattigo</em></p><p>This pass generates helper functions to configure the Lattigo objects for the given function.</p><p>For example, for an MLIR function <code>@my_func</code>, the generated helpers have the following signatures</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@my_func__configure</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(!</span>lattigo<span style=color:#000;font-weight:700>.</span>bgv<span style=color:#000;font-weight:700>.</span>evaluator<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>lattigo<span style=color:#000;font-weight:700>.</span>bgv<span style=color:#000;font-weight:700>.</span>parameter<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>lattigo<span style=color:#000;font-weight:700>.</span>bgv<span style=color:#000;font-weight:700>.</span>encoder<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>lattigo<span style=color:#000;font-weight:700>.</span>rlwe<span style=color:#000;font-weight:700>.</span>encryptor<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>lattigo<span style=color:#000;font-weight:700>.</span>rlwe<span style=color:#000;font-weight:700>.</span>decryptor<span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h4 id=options-16>Options</h4><pre tabindex=0><code>-entry-function : Default entry function name of entry function.
</code></pre><h3 id=-layout-optimization><code>-layout-optimization</code></h3><p><em>Optimize layout conversions in the IR</em></p><p>This pass performance a greedy layout optimization pass similar to the
automatic layout assignment from <a href=https://dl.acm.org/doi/pdf/10.1145/3656382>A Tensor Compiler with Automatic Data
Packing for Simple and Efficient Fully Homomorphic
Encryption</a>. The pass assumes that
an initial layout assignment was provided on each operation through the
<code>layout-propagation</code> pass.</p><p>The pass iterates on each operation of the IR in reverse order, attempting to
hoist a layout conversion of the operation&rsquo;s result before the operation. For
each of the result&rsquo;s layout conversions, the pass will compute the net cost of
hoisting the conversion through the operation by considering the following:</p><ol><li>The cost of performing the operation with new input layouts that result
in the desired layout.</li><li>The cost of the converting the layout of each input.</li><li>The new cost of converting from the desired layout to each other layout
conversions of the result.</li></ol><p>The layout conversion that results in the lowest net cost is chosen to be
hoisted.</p><p>Examples:</p><p>The second layout conversion could be eliminated by performing the first
addition operation under #map1.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>tensor =</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>stensor =</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>#map</span> <span style=color:#000;font-weight:700>=</span> affine_map<span style=color:#000;font-weight:700>&lt;(</span>d0<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span>d0 <span style=color:#a40000>+</span> <span style=color:#0000cf;font-weight:700>1</span> mod <span style=color:#0000cf;font-weight:700>32</span><span style=color:#000;font-weight:700>)&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#map1</span> <span style=color:#000;font-weight:700>=</span> affine_map<span style=color:#000;font-weight:700>&lt;(</span>d0<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span>d0<span style=color:#000;font-weight:700>)&gt;</span>
</span></span><span style=display:flex><span>module <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@push_conversion</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(!</span>stensor <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>stensor<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>stensor<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>attrs =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>__argattrs =</span> <span style=color:#a40000>\</span><span style=color:#000;font-weight:700>[</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>__resattrs =</span> <span style=color:#a40000>\</span><span style=color:#000;font-weight:700>[</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>#map1</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^body</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%input1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%input2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>convert_layout <span style=color:#000>%input1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>from_layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>#map</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>to_layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%input0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>convert_layout <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>from_layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>#map1</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>to_layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input2</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>stensor
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>This pass produces:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>tensor =</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>stensor =</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>#map</span> <span style=color:#000;font-weight:700>=</span> affine_map<span style=color:#000;font-weight:700>&lt;(</span>d0<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span>d0 <span style=color:#a40000>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#map1</span> <span style=color:#000;font-weight:700>=</span> affine_map<span style=color:#000;font-weight:700>&lt;(</span>d0<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span>d0<span style=color:#000;font-weight:700>)&gt;</span>
</span></span><span style=display:flex><span>module <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@push_conversion</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(!</span>stensor <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>stensor<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>stensor<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>attrs =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>__argattrs =</span> <span style=color:#a40000>\</span><span style=color:#000;font-weight:700>[</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>__resattrs =</span> <span style=color:#a40000>\</span><span style=color:#000;font-weight:700>[</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>#map1</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>\</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^body</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%input1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%input2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>convert_layout <span style=color:#000>%input0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>from_layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>to_layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input2</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>stensor
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=-layout-propagation><code>-layout-propagation</code></h3><p><em>Propagate ciphertext layouts through the IR</em></p><p>This pass performs a forward propagation of layout (packing) information
through the input IR, starting from the assumption that each secret tensor
argument to a function has a row-major layout.</p><p>The chosen layouts (<code>affine_map</code>s) are annotated on ops throughout the IR.
In particular,</p><ul><li>Ops with a nested region and block arguments use a dictionary attribute to
mark the layout of each block argument. <code>func.func</code> in particular uses the
<code>tensor_ext.layout</code> dialect attribute, while others use an affine map
attribute.</li><li>Other ops annotate their results with layouts as an ArrayAttr of affine
maps. The order of the affine maps corresponds to the order of results.</li></ul><p>When a plaintext SSA value is encountered as an input to a secret operation,
a <code>tensor_ext.assign_layout</code> op is inserted that assigns it a default layout.
This semantically corresponds to a plaintext packing operation. This is
performed as late as possible before the SSA value is used, to avoid
unnecessary layout conversions of plaintexts. This implies that not all SSA
values in the IR are annotated with layouts, only those that have secret
results or secret operands.</p><p>When two incompatible layouts are encountered as operands to the same op,
<code>tensor_ext.convert_layout</code> ops are inserted. For example, consider the
<code>linalg.reduce</code> operation for a summation. Summing along each of the two axes
of a row-major-packed <code>tensor&lt;32x32xi16></code> results in two <code>tensor&lt;32xi16></code>,
but with incompatible layouts: the first has a compact layout residing in the
first 32-entries of a ciphertext, while the second is a strided layout with a
stride of 32.</p><p>The converted op is arbitrarily chosen to have the layout of the first input,
and later passes are responsible for optimizing the choice of which operand
is converted and where the conversion operations are placed. This separation
of duties allows this pass to be reused as a pure dataflow analysis, in which
case it annotates an un-annotated IR with layout attributes.</p><p>Examples:</p><p>Two incompatible summations require a layout conversion</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>tensor =</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>tensor2 =</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>stensor =</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>stensor2 =</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@insert_conversion</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>stensor2 <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%out_1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%out_2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>stensor<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^body</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%pt_arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%pt_arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> linalg<span style=color:#000;font-weight:700>.</span>reduce <span style=color:#000;font-weight:700>{</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000;font-weight:700>}</span> ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%pt_arg0</span><span style=color:#000;font-weight:700>:!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>)</span> outs<span style=color:#000;font-weight:700>(</span><span style=color:#000>%out_1</span><span style=color:#000;font-weight:700>:!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span> <span style=color:#f57900>dimensions =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> linalg<span style=color:#000;font-weight:700>.</span>reduce <span style=color:#000;font-weight:700>{</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000;font-weight:700>}</span> ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%pt_arg1</span><span style=color:#000;font-weight:700>:!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>)</span> outs<span style=color:#000;font-weight:700>(</span><span style=color:#000>%out_2</span><span style=color:#000;font-weight:700>:!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span> <span style=color:#f57900>dimensions =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>stensor2
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>stensor2
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>This pass produces:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000>#map</span> <span style=color:#000;font-weight:700>=</span> affine_map<span style=color:#000;font-weight:700>&lt;(</span>d0<span style=color:#000;font-weight:700>,</span> d1<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span>d0 <span style=color:#000;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>32</span> <span style=color:#a40000>+</span> d1<span style=color:#000;font-weight:700>)&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#map1</span> <span style=color:#000;font-weight:700>=</span> affine_map<span style=color:#000;font-weight:700>&lt;(</span>d0<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span>d0<span style=color:#000;font-weight:700>)&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#map2</span> <span style=color:#000;font-weight:700>=</span> affine_map<span style=color:#000;font-weight:700>&lt;(</span>d0<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span>d0 <span style=color:#000;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>32</span><span style=color:#000;font-weight:700>)&gt;</span>
</span></span><span style=display:flex><span>module <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@insert_conversion</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#tensor_ext.layout</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>layout =</span> <span style=color:#000;font-weight:700>(</span>d0<span style=color:#000;font-weight:700>,</span> d1<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span>d0 <span style=color:#000;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>32</span> <span style=color:#a40000>+</span> d1<span style=color:#000;font-weight:700>)&gt;},</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#tensor_ext.layout</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>layout =</span> <span style=color:#000;font-weight:700>(</span>d0<span style=color:#000;font-weight:700>,</span> d1<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span>d0 <span style=color:#000;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>32</span> <span style=color:#a40000>+</span> d1<span style=color:#000;font-weight:700>)&gt;}</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#tensor_ext.layout</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>layout =</span> <span style=color:#000;font-weight:700>(</span>d0<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span>d0<span style=color:#000;font-weight:700>)&gt;})</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cst</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cst_0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f57900>attrs =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>arg0 =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>},</span> <span style=color:#f57900>arg1 =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map</span><span style=color:#000;font-weight:700>},</span> <span style=color:#f57900>layout =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>#map1</span><span style=color:#000;font-weight:700>]}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^body</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%input1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>assign_layout <span style=color:#000>%cst</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%reduced</span> <span style=color:#000;font-weight:700>=</span> linalg<span style=color:#000;font-weight:700>.</span>reduce <span style=color:#000;font-weight:700>{</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>overflowFlags =</span> <span style=color:#000>#arith.overflow</span><span style=color:#000;font-weight:700>&lt;</span>none<span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                  ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%input0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span>
</span></span><span style=display:flex><span>                  outs<span style=color:#000;font-weight:700>(</span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span>
</span></span><span style=display:flex><span>                  <span style=color:#f57900>dimensions =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span>  <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>#map1</span><span style=color:#000;font-weight:700>]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>assign_layout <span style=color:#000>%cst_0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>convert_layout <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>from_layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>layout =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>#map2</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>to_layout =</span> <span style=color:#000>#map2</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%reduced_1</span> <span style=color:#000;font-weight:700>=</span> linalg<span style=color:#000;font-weight:700>.</span>reduce <span style=color:#000;font-weight:700>{</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>overflowFlags =</span> <span style=color:#000>#arith.overflow</span><span style=color:#000;font-weight:700>&lt;</span>none<span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                  ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%input1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span>
</span></span><span style=display:flex><span>                  outs<span style=color:#000;font-weight:700>(</span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span>
</span></span><span style=display:flex><span>                  <span style=color:#f57900>dimensions =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span>  <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>#map2</span><span style=color:#000;font-weight:700>]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>convert_layout <span style=color:#000>%reduced_1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>from_layout =</span> <span style=color:#000>#map2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>layout =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>#map1</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>to_layout =</span> <span style=color:#000>#map1</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%reduced</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>tensor_ext.layout =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>#map1</span><span style=color:#000;font-weight:700>]}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=options-17>Options</h4><pre tabindex=0><code>-ciphertext-size : Power of two length of the ciphertexts the data is packed in.
</code></pre><h3 id=-linalg-canonicalizations><code>-linalg-canonicalizations</code></h3><p><em>This pass canonicalizes the linalg.transpose operation of a constant into a transposed constant.</em></p><p>This pass canonicalizes the linalg.transpose operation of a constant into a
transposed constant.</p><h3 id=-lower-polynomial-eval><code>-lower-polynomial-eval</code></h3><p><em>Lowers the polynomial.eval operation</em></p><p>This pass lowers the <code>polynomial.eval</code> operation to a sequence of arithmetic
operations in the relevant dialect.</p><p>Dialects that wish to support this pass must implement the
<code>DialectPolynomialEvalInterface</code> dialect interface, which informs this pass
what operations in the target dialect correspond to scalar multiplication and
addition, as well as how to properly materialize constants as values.</p><p>This pass supports multiple options for lowering a <code>polynomial.eval</code> op,
including the following. The required basis representation of the polynomial
is listed alongside each method. The chosen method is controlled by the
<code>method</code> pass option, which defaults to automatically select the method.</p><ul><li><code>"horner"</code>: Horner&rsquo;s method (monomial basis)</li><li><code>"ps"</code> Paterson-Stockmeyer (monomial basis)</li></ul><p>// TODO(#1565): Add support for Chebyshev-basis methods
// - <code>"clenshaw"</code>: Clenshaw&rsquo;s method (Chebyshev basis)
// - <code>"ps-cheb"</code>: Paterson-Stockmeyer (Chebyshev basis)
// - <code>"bsgs"</code>: Baby Step Giant Step (Chebyshev basis)</p><h4 id=options-18>Options</h4><pre tabindex=0><code>-method : The method used to lower polynomial.eval
</code></pre><h3 id=-lower-unpack><code>-lower-unpack</code></h3><p><em>Lower tensor_ext.unpack to standard MLIR</em></p><p>This pass lowers tensor_ext.unpack.</p><h3 id=-lwe-add-debug-port><code>-lwe-add-debug-port</code></h3><p><em>Add debug port to (R)LWE encrypted functions</em></p><p>This pass adds debug ports to the specified function in the IR. The debug ports
are prefixed with &ldquo;__heir_debug&rdquo; and are invoked after each homomorphic operation in the
function. The debug ports are declarations and user should provide functions with
the same name in their code.</p><p>For example, if the function is called &ldquo;foo&rdquo;, the secret key is added to its
arguments, and the debug port is called after each homomorphic operation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// declaration of external debug function
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> private <span style=color:#000>@__heir_debug</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%sk</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>sk<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%ct</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>ct<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// secret key added as function arg
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%sk</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>sk<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>...)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%ct</span> <span style=color:#000;font-weight:700>=</span> lwe<span style=color:#000;font-weight:700>.</span>radd <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// invoke external debug function
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  __heir_debug<span style=color:#000;font-weight:700>(</span><span style=color:#000>%sk</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%ct</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%ct1</span> <span style=color:#000;font-weight:700>=</span> lwe<span style=color:#000;font-weight:700>.</span>rmul <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  __heir_debug<span style=color:#000;font-weight:700>(</span><span style=color:#000>%sk</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%ct1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=options-19>Options</h4><pre tabindex=0><code>-entry-function : Default entry function name of entry function.
</code></pre><h3 id=-lwe-to-lattigo><code>-lwe-to-lattigo</code></h3><p><em>Lower <code>lwe</code> to <code>lattigo</code> dialect.</em></p><p>This pass lowers the <code>lwe</code> dialect to <code>Lattigo</code> dialect.</p><h3 id=-lwe-to-openfhe><code>-lwe-to-openfhe</code></h3><p><em>Lower <code>lwe</code> to <code>openfhe</code> dialect.</em></p><p>This pass lowers the <code>lwe</code> dialect to <code>Openfhe</code> dialect.
Currently, this also includes patterns that apply directly to <code>ckks</code> and <code>bgv</code> dialect operations.
TODO (#1193): investigate if the need for <code>ckks/bgv</code> patterns in <code>--lwe-to-openfhe</code> is permanent.</p><h3 id=-lwe-to-polynomial><code>-lwe-to-polynomial</code></h3><p><em>Lower <code>lwe</code> to <code>polynomial</code> dialect.</em></p><p>This pass lowers the <code>lwe</code> dialect to <code>polynomial</code> dialect.</p><h3 id=-memref-global-replace><code>-memref-global-replace</code></h3><p><em>MemrefGlobalReplacePass forwards global memrefs accessors to arithmetic values</em></p><p>This pass forwards constant global MemRef values to referencing affine
loads. This pass requires that the MemRef global values are initialized as
constants and that the affine load access indices are constants (i.e. not
variadic). Unroll affine loops prior to running this pass.</p><p>MemRef removal is required to remove any memory allocations from the input
model (for example, TensorFlow models contain global memory holding model
weights) to support FHE transpilation.</p><p>Input</p><pre tabindex=0><code>module {
  memref.global &#34;private&#34; constant @__constant_8xi16 : memref&lt;2x4xi16&gt; = dense&lt;[[-10, 20, 3, 4], [5, 6, 7, 8]]&gt;
  func.func @main() -&gt; i16 {
    %c1 = arith.constant 1 : index
    %c2 = arith.constant 2 : index
    %0 = memref.get_global @__constant_8xi16 : memref&lt;2x4xi16&gt;
    %1 = affine.load %0[%c1, %c1 + %c2] : memref&lt;2x4xi16&gt;
    return %1 : i16
  }
}
</code></pre><p>Output</p><pre tabindex=0><code>module {
  func.func @main() -&gt; i16 {
    %c1 = arith.constant 1 : index
    %c2 = arith.constant 2 : index
    %c8_i16 = arith.constant 8 : i16
    return %c8_i16 : i16
  }
}
</code></pre><h3 id=-mod-arith-to-arith><code>-mod-arith-to-arith</code></h3><p><em>Lower <code>mod_arith</code> to standard <code>arith</code>.</em></p><p>This pass lowers the <code>mod_arith</code> dialect to their <code>arith</code> equivalents.</p><h3 id=-mod-arith-to-mac><code>-mod-arith-to-mac</code></h3><p><em>Finds consecutive ModArith mul and add operations and converts them to a Mac operation</em></p><p>Walks over the programs to find Add operations, it checks if the any operands
originates from a mul operation. If so, it converts the Add operation to a
Mac operation and removes the mul operation.</p><h3 id=-openfhe-configure-crypto-context><code>-openfhe-configure-crypto-context</code></h3><p><em>Configure the crypto context in OpenFHE</em></p><p>This pass generates helper functions to generate and configure the OpenFHE crypto context for the given function. Generating the crypto context sets the appropriate encryption parameters, while the configuration generates the necessary evaluation keys (relinearization and rotation keys).</p><p>For the options, reader can refer to the OpenFHE documentation at
<a href=https://github.com/openfheorg/openfhe-development/blob/main/src/pke/examples/README.md#description-of-the-cryptocontext-parameters-and-their-restrictions>https://github.com/openfheorg/openfhe-development/blob/main/src/pke/examples/README.md#description-of-the-cryptocontext-parameters-and-their-restrictions</a></p><p>For example, for an MLIR function <code>@my_func</code>, the generated helpers have the following signatures</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span>  <span style=color:#000>@my_func__generate_crypto_context</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span>  <span style=color:#000>@my_func__configure_crypto_context</span><span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>private_key<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context
</span></span></code></pre></div><h4 id=options-20>Options</h4><pre tabindex=0><code>-entry-function                 : Default entry function name of entry function.
-mul-depth                      : Manually specify the mul depth
-ring-dim                       : Manually specify the ring dimension (insecure is implied)
-batch-size                     : Manually specify the batch size
-first-mod-size                 : Manually specify the first mod size
-scaling-mod-size               : Manually specify the scaling mod size
-digit-size                     : Manually specify the digit size for relinearization
-num-large-digits               : Manually specify the number of large digits for HYBRID relinearization
-max-relin-sk-deg               : Manually specify the max number of relin sk deg
-insecure                       : Whether to use insecure parameter (defaults to false)
-key-switching-technique-bv     : Whether to use BV key switching technique (defaults to false)
-scaling-technique-fixed-manual : Whether to use fixed manual scaling technique (defaults to false)
-level-budget-encode            : Level budget for CKKS bootstrap encode (s2c) phase
-level-budget-decode            : Level budget for CKKS bootstrap decode (c2s) phase
</code></pre><h3 id=-openfhe-count-add-and-key-switch><code>-openfhe-count-add-and-key-switch</code></h3><p><em>Count the number of add and key-switch operations in OpenFHE</em></p><p>This pass counts the number of add and key-switch operations in the given function.</p><p>This is used for setting the EvalAddCount and EvalKeySwitchCount in OpenFHE library.
Cf. <a href=https://eprint.iacr.org/2024/203>Alexandru et al. 2024</a> for why this
is important for security.</p><p>The detailed definition of these counts could be found in the KPZ21 paper
<a href=https://ia.cr/2021/204>Revisiting Homomorphic Encryption Schemes for Finite Fields</a></p><p>The pass should be run at the secret arithmetic level when management operations
have been inserted and the IR is stable.</p><h3 id=-operation-balancer><code>-operation-balancer</code></h3><p><em>This pass balances addition and multiplication operations.</em></p><p>This pass examines a tree or graph of add and multiplication operations and
balances them to minimize the depth of the tree. This exposes better parallelization
and reducing the multiplication depth can decrease the parameters used in FHE,
which improves performance. This pass is not necessarily optimal, as there may
be intermediate computations that this pass does not optimally minimize the depth for.</p><p>The algorithm is to analyze a graph of addition operations and do a depth-first
search for the operands (from the last computed values in the graph). If there
are intermediate computations that are used more than once, then the pass
treats that computation as its own tree to balance instead of trying to minimize
the global depth of the tree.</p><p>This pass only runs on addition and multiplication operations on the arithmetic
dialect that are encapsulated inside a secret.generic.</p><p>This pass was inspired by section 2.6 of <a href=https://eprint.iacr.org/2021/1505>&lsquo;EVA Improved: Compiler and Extension
Library for CKKS&rsquo; by Chowdhary et al</a>.</p><h3 id=-optimize-relinearization><code>-optimize-relinearization</code></h3><p><em>Optimize placement of relinearization ops</em></p><p>This pass defers relinearization ops as late as possible in the IR.
This is more efficient in cases where multiplication operations are followed by
additions, such as in a dot product. Because relinearization also adds error,
deferring it can reduce the need for bootstrapping.</p><p>In this pass, we use an integer linear program to determine the optimal
relinearization strategy. It solves an ILP for each <code>func</code> op in the IR.</p><p>The assumptions of this pass include:</p><ul><li>All return values of functions must be linearized.</li><li>All ciphertext arguments to an op must have the same key basis</li><li>Rotation op inputs must have be linearized.</li></ul><p>For an ILP model specification, see the
<a href=https://heir.dev/docs/design/relinearization_ilp/>docs at the HEIR website</a>.
The model is an adaptation of the ILP described in
<a href=https://www.jeremykun.com/2023/11/15/mlir-a-global-optimization-and-dataflow-analysis>a blog post by Jeremy Kun</a>.</p><h4 id=options-21>Options</h4><pre tabindex=0><code>-use-loc-based-variable-names : When true, the ILP uses op source locations in variable names, which can help debug ILP model bugs.
-allow-mixed-degree-operands  : When true, allow ops to have mixed-degree ciphertexts as inputs, e.g., adding two ciphertexts with different key bases; this is supported by many FHE backends, like OpenFHE and Lattigo
</code></pre><h3 id=-polynomial-approximation><code>-polynomial-approximation</code></h3><p><em>Approximate ops by polynomials</em></p><p>This pass replaces certain operations that are incompatible
with the FHE computational model with polynomial approximations.</p><p>The pass applies to the following ops in the <code>math</code> dialect. When the
op is binary, the pass applies when one op is the result of an
<code>arith.constant</code> which is scalar-valued or a splatted tensor.</p><ul><li><code>absf</code></li><li><code>acos</code></li><li><code>acosh</code></li><li><code>asin</code></li><li><code>asinh</code></li><li><code>atan2</code></li><li><code>atan</code></li><li><code>atanh</code></li><li><code>cbrt</code></li><li><code>ceil</code></li><li><code>copysign</code></li><li><code>cos</code></li><li><code>cosh</code></li><li><code>erf</code></li><li><code>erfc</code></li><li><code>exp2</code></li><li><code>exp</code></li><li><code>expm1</code></li><li><code>floor</code></li><li><code>fpowi</code></li><li><code>log10</code></li><li><code>log1p</code></li><li><code>log2</code></li><li><code>log</code></li><li><code>powf</code></li><li><code>round</code></li><li><code>roundeven</code></li><li><code>rsqrt</code></li><li><code>sin</code></li><li><code>sinh</code></li><li><code>sqrt</code></li><li><code>tan</code></li><li><code>tanh</code></li><li><code>trunc</code></li></ul><p>The following ops in the <code>arith</code> dialect are also supported:</p><ul><li><code>maxf</code></li><li><code>maxnumf</code></li><li><code>minf</code></li><li><code>minnumf</code></li></ul><p>These ops are replaced with <code>polynomial.eval</code> ops with a static polynomial
attribute.</p><p>Examples:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> math<span style=color:#000;font-weight:700>.</span>exp <span style=color:#000>%x</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>degree =</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>domain_lower =</span> <span style=color:#0000cf;font-weight:700>-1.0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f64</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#f57900>domain_upper =</span> <span style=color:#0000cf;font-weight:700>1.0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f64</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f32</span>
</span></span></code></pre></div><p>is converted to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000>#ring_f64_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#polynomial.ring</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>coefficientType =</span> <span style=color:#204a87;font-weight:700>f64</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>poly =</span> <span style=color:#000;font-weight:700>!</span>polynomial<span style=color:#000;font-weight:700>.</span>polynomial<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>ring =</span> <span style=color:#000>#ring_f64_</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> polynomial<span style=color:#000;font-weight:700>.</span>eval
</span></span><span style=display:flex><span>       <span style=color:#000>#polynomial</span><span style=color:#000;font-weight:700>&lt;</span>typed_float_polynomial <span style=color:#000;font-weight:700>&lt;</span>
</span></span><span style=display:flex><span>         <span style=color:#0000cf;font-weight:700>0.99458116404270657</span>
</span></span><span style=display:flex><span>       <span style=color:#a40000>+</span> <span style=color:#0000cf;font-weight:700>0.99565537253615788</span><span style=color:#000;font-weight:700>x</span>
</span></span><span style=display:flex><span>       <span style=color:#a40000>+</span> <span style=color:#0000cf;font-weight:700>0.54297028147256321</span><span style=color:#000;font-weight:700>x**</span><span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>       <span style=color:#a40000>+</span> <span style=color:#0000cf;font-weight:700>0.17954582110873779</span><span style=color:#000;font-weight:700>x**</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>poly<span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f32</span>
</span></span></code></pre></div><h3 id=-polynomial-to-mod-arith><code>-polynomial-to-mod-arith</code></h3><p><em>Lower <code>polynomial</code> to standard MLIR dialects.</em></p><p>This pass lowers the <code>polynomial</code> dialect to standard MLIR plus mod_arith,
including possibly ops from affine, tensor, linalg, and arith.</p><h3 id=-populate-scale-bgv><code>-populate-scale-bgv</code></h3><p><em>Populate the scale for BGV (GHS variant) ciphertext</em></p><p>In the original BGV scheme, it is required that each modulus in
the modulus chain is a prime number q such that $q \equiv 1 \pmod{t}$,
the plaintext modulus. This is to ensure that the after each modulus
switching, the plaintext message is preserved. However, this limits
the possible choices of the moduli chain.</p><p>In the GHS variant of BGV, such requirement is removed by introducing
scaling factor to the ciphertext, with the cost of scale management.
This pass is responsible for such management.</p><p>This pass relies on concrete SchemeParamAttr annotated on the module
to determine the scale for each ciphertext. Such annotation can be
generated by the <code>generate-param-bgv</code> pass.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>module attributes <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>bgv.schemeParam =</span> <span style=color:#000>#bgv.scheme_param</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>logN =</span> <span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>Q =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>67239937</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>8796093202433</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>P =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>8796093349889</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>plaintextModulus =</span> <span style=color:#0000cf;font-weight:700>65537</span><span style=color:#000;font-weight:700>&gt;,</span> scheme<span style=color:#000;font-weight:700>.</span>bgv<span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@mul</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#f57900>attrs =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>__argattrs =</span> <span style=color:#000;font-weight:700>[{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>scale =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>__resattrs =</span> <span style=color:#000;font-weight:700>[{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>scale =</span> <span style=color:#0000cf;font-weight:700>42541</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>]}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^body</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%input0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>dimension =</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>scale =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> mgmt<span style=color:#000;font-weight:700>.</span>relinearize <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>scale =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> mgmt<span style=color:#000;font-weight:700>.</span>modreduce <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>scale =</span> <span style=color:#0000cf;font-weight:700>42541</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=-populate-scale-ckks><code>-populate-scale-ckks</code></h3><p><em>Populate the scale for CKKS ciphertext</em></p><p>In CKKS, each ciphertext is associated with a scaling factor $\Delta$,
and such scaling factor will change after homomorphic operations
such as multiplication and modulus reducing.</p><p>However, certain operations such as addition require the input ciphertexts
to have the same scale. This pass is then responsible for managing the scale
of the ciphertexts.</p><p>This pass relies on concrete SchemeParamAttr annotated on the module
to determine the scale for each ciphertext. Such annotation can be
generated by the <code>generate-param-ckks</code> pass.</p><p>The scaling factor is expressed in logarithm form.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>module attributes <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>ckks.schemeParam =</span> <span style=color:#000>#ckks.scheme_param</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>logN =</span> <span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>Q =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>36028797019389953</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>35184372121601</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>P =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>36028797019488257</span><span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>logDefaultScale =</span> <span style=color:#0000cf;font-weight:700>45</span><span style=color:#000;font-weight:700>&gt;,</span> scheme<span style=color:#000;font-weight:700>.</span>ckks<span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@mul</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f32</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f32</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#f57900>attrs =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>__argattrs =</span> <span style=color:#000;font-weight:700>[{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>scale =</span> <span style=color:#0000cf;font-weight:700>45</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>],</span> <span style=color:#f57900>__resattrs =</span> <span style=color:#000;font-weight:700>[{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>scale =</span> <span style=color:#0000cf;font-weight:700>45</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>]}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^body</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f32</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>mulf <span style=color:#000>%input0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>dimension =</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>scale =</span> <span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> mgmt<span style=color:#000;font-weight:700>.</span>relinearize <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>scale =</span> <span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> mgmt<span style=color:#000;font-weight:700>.</span>modreduce <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>scale =</span> <span style=color:#0000cf;font-weight:700>45</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f32</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f32</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>f32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=options-22>Options</h4><pre tabindex=0><code>-before-mul-include-first-mul : Modulus switching before each multiplication, including the first multiplication (default to false)
</code></pre><h3 id=-propagate-annotation><code>-propagate-annotation</code></h3><p><em>Propagate annotation from operation to subsequent operations</em></p><p>This pass propagates the attribute from one operation to subsequent operations
if these operations does not have the attribute already.</p><p>Example: with <code>--propagate-annotation=attr-name=test.attr</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>test.attr =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> mgmt<span style=color:#000;font-weight:700>.</span>relinearize <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>the above IR becomes</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>test.attr =</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>test.attr =</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> mgmt<span style=color:#000;font-weight:700>.</span>relinearize <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>test.attr =</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>test.attr =</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=options-23>Options</h4><pre tabindex=0><code>-attr-name : The attribute name to propagate with.
-reverse   : Whether to propagate in reverse
</code></pre><h3 id=-remove-unused-memref><code>-remove-unused-memref</code></h3><p><em>Cleanup any unused memrefs</em></p><p>Scan the IR for unused memrefs and remove them.</p><p>This pass looks for locally allocated memrefs that are never used and
deletes them. This pass can be used as a cleanup pass from other IR
simplifications that forward stores to loads.</p><h3 id=-rotate-and-reduce><code>-rotate-and-reduce</code></h3><p><em>Use a logarithmic number of rotations to reduce a tensor.</em></p><p>This pass identifies when a commutative, associative binary operation is used
to reduce all of the entries of a tensor to a single value, and optimizes the
operations by using a logarithmic number of reduction operations.</p><p>In particular, this pass identifies an unrolled set of operations of the form
(the binary ops may come in any order):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%t</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%t</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%t</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%t</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%t</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%t</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%6</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%t</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%7</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%t</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span><span style=color:#000>%9</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%8</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span><span style=color:#000>%10</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%9</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span><span style=color:#000>%11</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%10</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span><span style=color:#000>%12</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%11</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span><span style=color:#000>%13</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%12</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span><span style=color:#000>%14</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%13</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span></code></pre></div><p>and replaces it with a logarithmic number of <code>rotate</code> and <code>addi</code> operations:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%t</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%t</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><h3 id=-secret-add-debug-port><code>-secret-add-debug-port</code></h3><p><em>Add debug port to secret-arithmetic ops</em></p><p>This pass adds debug ports to secret-arithmetic ops in the IR, namely operations
wrapped by secret.generic. The debug ports are prefixed with &ldquo;__heir_debug&rdquo; and
are invoked after each operation in the generic body. The debug ports are
declarations and user should provide functions with the same name in their code.</p><p>For example, if the function is called &ldquo;foo&rdquo;, the debug port is called after
each homomorphic operation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// declaration of external debug function
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> private <span style=color:#000>@__heir_debug_tensor_8xi16_</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@foo</span><span style=color:#000;font-weight:700>(...)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  secret<span style=color:#000;font-weight:700>.</span>generic <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// invoke external debug function
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    __heir_debug_tensor_8xi16_<span style=color:#000;font-weight:700>(</span><span style=color:#000>%0</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    __heir_debug_tensor_8xi16_<span style=color:#000;font-weight:700>(</span><span style=color:#000>%1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=-secret-capture-generic-ambient-scope><code>-secret-capture-generic-ambient-scope</code></h3><p><em>Capture the ambient scope used in a secret.generic</em></p><p>For each value used in the body of a <code>secret.generic</code> op, which is defined
in the ambient scope outside the <code>generic</code>, add it to the argument list of
the <code>generic</code>.</p><h3 id=-secret-distribute-generic><code>-secret-distribute-generic</code></h3><p><em>Distribute <code>generic</code> ops through their bodies.</em></p><p>Converts <code>generic</code> ops whose region contains many ops into smaller
sequences of generic ops whose regions contain a single op, dropping the
<code>generic</code> part from any resulting <code>generic</code> ops that have no
<code>secret.secret</code> inputs. If the op has associated regions, and the operands
are not secret, then the generic is distributed recursively through the
op&rsquo;s regions as well.</p><p>This pass is intended to be used as part of a front-end pipeline, where a
program that operates on a secret type annotates the input to a region as
<code>secret</code>, and then wraps the contents of the region in a single large
<code>secret.generic</code>, then uses this pass to simplify it.</p><p>The <code>distribute-through</code> option allows one to specify a comma-separated
list of op names (e.g., <code>distribute-thorugh="affine.for,scf.if"</code>), which
limits the distribution to only pass through those ops. If unset, all ops
are distributed through when possible.</p><h4 id=options-24>Options</h4><pre tabindex=0><code>-distribute-through : comma-separated list of ops that should be distributed through
</code></pre><h3 id=-secret-extract-generic-body><code>-secret-extract-generic-body</code></h3><p><em>Extract the bodies of all generic ops into functions</em></p><p>This pass extracts the body of all generic ops into functions, and
replaces the generic bodies with call ops. Used as a sub-operation in
some passes, and extracted into its own pass for testing purposes.</p><p>This pass works best when <code>--secret-generic-absorb-constants</code> is run
before it so that the extracted function contains any constants used
in the generic op&rsquo;s body.</p><h3 id=-secret-forget-secrets><code>-secret-forget-secrets</code></h3><p><em>Convert secret types to standard types</em></p><p>Drop the <code>secret&lt;...></code> type from the IR, replacing it with the contained
type and the corresponding cleartext computation.</p><p><code>secret.cast</code> ops are replaced with freshly alloc&rsquo;ed memrefs that extract
individual bits of the input type or reshape them if possible.</p><h3 id=-secret-generic-absorb-constants><code>-secret-generic-absorb-constants</code></h3><p><em>Copy constants into a secret.generic body</em></p><p>For each constant value used in the body of a <code>secret.generic</code> op, which is
defined in the ambient scope outside the <code>generic</code>, add it&rsquo;s definition into
the <code>generic</code> body.</p><h3 id=-secret-generic-absorb-dealloc><code>-secret-generic-absorb-dealloc</code></h3><p><em>Copy deallocs of internal memrefs into a secret.generic body</em></p><p>For each memref allocated and used only within a body of a <code>secret.generic</code>
op, add it&rsquo;s dealloc of the memref into its <code>generic</code> body.</p><h3 id=-secret-import-execution-result><code>-secret-import-execution-result</code></h3><p><em>Annotate execution result to secret-arithmetic ops</em></p><p>When the execution result of each op is known by <code>secret-add-debug-port</code> pass,
the result could be imported back to the IR.</p><p>This pass adds a new attribute <code>secret.execution_result</code> to the secret-arithmetic ops.</p><p>This is useful when users want to compare the precision of the result between
the plaintext and the ciphertext (especially the CKKS case).</p><p>For example, if you have a <code>trace.log</code> that is generated by plaintext backend with
<code>--secret-add-debug-port</code> where the result is printed out like</p><pre tabindex=0><code>1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0
2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0
</code></pre><p>Each <em>line</em> corresponds to one SSA value in the IR. You can then import the result
back to the IR by using <code>--secret-import-execution-result=file-name=trace.log</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@foo</span><span style=color:#000;font-weight:700>(...)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  secret<span style=color:#000;font-weight:700>.</span>generic <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000;font-weight:700>...</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>secret.execution_result =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1.0</span> <span style=color:#0000cf;font-weight:700>2.0</span> <span style=color:#0000cf;font-weight:700>3.0</span> <span style=color:#0000cf;font-weight:700>4.0</span> <span style=color:#0000cf;font-weight:700>5.0</span> <span style=color:#0000cf;font-weight:700>6.0</span> <span style=color:#0000cf;font-weight:700>7.0</span> <span style=color:#0000cf;font-weight:700>8.0</span><span style=color:#000;font-weight:700>]}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000;font-weight:700>...</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>secret.execution_result =</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>2.0</span> <span style=color:#0000cf;font-weight:700>3.0</span> <span style=color:#0000cf;font-weight:700>4.0</span> <span style=color:#0000cf;font-weight:700>5.0</span> <span style=color:#0000cf;font-weight:700>6.0</span> <span style=color:#0000cf;font-weight:700>7.0</span> <span style=color:#0000cf;font-weight:700>8.0</span> <span style=color:#0000cf;font-weight:700>9.0</span><span style=color:#000;font-weight:700>]}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=options-25>Options</h4><pre tabindex=0><code>-file-name : file name of the execution result
</code></pre><h3 id=-secret-insert-mgmt-bfv><code>-secret-insert-mgmt-bfv</code></h3><p><em>Place BFV ciphertext management operations</em></p><p>This pass inserts relinearization operation for multiplication, and
compute the multiplicative depth, or the level information.</p><p>For most cases B/FV is instantiated with no mod reduce so it is not a leveled scheme.
However, for instantiating B/FV parameters it is often meaningful to know the multiplicative
depth of the circuit.</p><p>Example of multiplication+addition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>which get transformed to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#f57900>attrs =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>arg0 =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;},</span> <span style=color:#f57900>arg1 =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;}}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^body</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%input0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>dimension =</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> mgmt<span style=color:#000;font-weight:700>.</span>relinearize <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=-secret-insert-mgmt-bgv><code>-secret-insert-mgmt-bgv</code></h3><p><em>Place BGV ciphertext management operations</em></p><p>This pass implements the following placement strategy:</p><p>For relinearize, after every homomorphic ciphertext-ciphertext multiplication,
a mgmt.relinearize is placed after the operation. This is done to ensure that
the ciphertext keeps <em>linear</em>.</p><p>For modulus switching, it is inserted right before a homomorphic multiplication,
including ciphertext-plaintext ones. There is an option <code>include-first</code> controlling
whether to switch modulus before the first multiplication.</p><p>User can check the FLEXIBLEAUTOEXT and FLEXIBLEAUTO mode in OpenFHE as a reference.
To know more technical difference about them, user can refer to the paper
<a href=https://ia.cr/2021/204>&ldquo;Revisiting homomorphic encryption schemes for finite firelds&rdquo;</a>.</p><p>Then, for level-mismatching binary operations like addition and subtraction,
additional modulus switch is placed for the operand until it reaches the same level.</p><p>This is different from crosslevel operation handling in other implementations like using
modulus switching and level drop together. The reason we only use modulus switching is
for simplicity for now. Further optimization on this pass could implement such a strategy.</p><p>Before yield the final result, a modulus switching is placed if it is a result
of multiplication or derived value of a multiplication.</p><p>Also, it annotates the mgmt.mgmt attribute for each operation, which
includes the level and dimension information of a ciphertext. This information
is subsequently used by the secret-to-bgv pass to properly lower to corresponding
RNS Type.</p><p>Example of multiplication+addition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>which get transformed to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#f57900>attrs =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>arg0 =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;},</span> <span style=color:#f57900>arg1 =</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;}}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>dimension =</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> mgmt<span style=color:#000;font-weight:700>.</span>relinearize <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> mgmt<span style=color:#000;font-weight:700>.</span>modreduce <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>mgmt.mgmt =</span> <span style=color:#000>#mgmt.mgmt</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>level =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=options-26>Options</h4><pre tabindex=0><code>-after-mul                    : Modulus switching after each multiplication (default to false)
-before-mul-include-first-mul : Modulus switching before each multiplication, including the first multiplication (default to false)
</code></pre><h3 id=-secret-insert-mgmt-ckks><code>-secret-insert-mgmt-ckks</code></h3><p><em>Place CKKS ciphertext management operations</em></p><p>Check the description of secret-insert-mgmt-bgv. This pass
implements similar strategy, where mgmt.modreduce stands for
ckks.rescale here.</p><p>For bootstrap insertion policy, currently a greedy policy is used
where when all levels are consumed then a bootstrap is inserted.</p><p>The max level available after bootstrap is controlled by the option
<code>bootstrap-waterline</code>.</p><p>Number of bootstrap consumed level is not shown here, which is
handled by further lowering.
TODO(#1207): handle it here so parameter selection can depend on it.
TODO(#1207): with this info we can encrypt at max level (with bootstrap consumed level).</p><h4 id=options-27>Options</h4><pre tabindex=0><code>-after-mul                    : Modulus switching after each multiplication (default to false)
-before-mul-include-first-mul : Modulus switching before each multiplication, including the first multiplication (default to false)
-slot-number                  : Default number of slots use for ciphertext space.
-bootstrap-waterline          : Waterline for insert bootstrap op
</code></pre><h3 id=-secret-merge-adjacent-generics><code>-secret-merge-adjacent-generics</code></h3><p><em>Merge two adjacent generics into a single generic</em></p><p>This pass merges two immedaitely sequential generics into a single
generic. Useful as a sub-operation in some passes, and extracted into
its own pass for testing purposes.</p><h3 id=-secret-to-bgv><code>-secret-to-bgv</code></h3><p><em>Lower <code>secret</code> to <code>bgv</code> dialect.</em></p><p>This pass lowers an IR with <code>secret.generic</code> blocks containing arithmetic
operations to operations on ciphertexts with the BGV dialect.</p><p>The pass assumes that the <code>secret.generic</code> regions have been distributed
through arithmetic operations so that only one ciphertext operation appears
per generic block. It also requires that <code>canonicalize</code> was run so that
non-secret values used are removed from the <code>secret.generic</code>&rsquo;s block
arguments.</p><p>The pass requires that all types are tensors of a uniform shape matching the
dimension of the ciphertext space specified my <code>poly-mod-degree</code>.</p><h4 id=options-28>Options</h4><pre tabindex=0><code>-poly-mod-degree : Default degree of the cyclotomic polynomial modulus to use for ciphertext space.
</code></pre><h3 id=-secret-to-cggi><code>-secret-to-cggi</code></h3><p><em>Lower <code>secret</code> to <code>cggi</code> dialect.</em></p><p>This pass lowers the <code>secret</code> dialect to <code>cggi</code> dialect.</p><h3 id=-secret-to-ckks><code>-secret-to-ckks</code></h3><p><em>Lower <code>secret</code> to <code>ckks</code> dialect.</em></p><p>This pass lowers an IR with <code>secret.generic</code> blocks containing arithmetic
operations to operations on ciphertexts with the CKKS dialect.</p><p>The pass assumes that the <code>secret.generic</code> regions have been distributed
through arithmetic operations so that only one ciphertext operation appears
per generic block. It also requires that <code>canonicalize</code> was run so that
non-secret values used are removed from the <code>secret.generic</code>&rsquo;s block
arguments.</p><p>The pass requires that all types are tensors of a uniform shape matching the
dimension of the ciphertext space specified my <code>poly-mod-degree</code>.</p><h4 id=options-29>Options</h4><pre tabindex=0><code>-poly-mod-degree : Default degree of the cyclotomic polynomial modulus to use for ciphertext space.
</code></pre><h3 id=-secret-to-mod-arith><code>-secret-to-mod-arith</code></h3><p><em>Lower <code>secret</code> to <code>mod-arith</code> dialect.</em></p><p>This pass lowers an IR with <code>secret.generic</code> blocks containing arithmetic
operations to operations on plaintexts using the <code>mod_arith</code> dialect.
This is primarily used in the plaintext lowering pipeline, where operations
are performed directly against plaintexts.</p><p>The pass assumes that the <code>secret.generic</code> regions have been distributed
through arithmetic operations so that only one ciphertext operation appears
per generic block. It also requires that <code>canonicalize</code> was run so that
non-secret values used are removed from the <code>secret.generic</code>&rsquo;s block
arguments.</p><h4 id=options-30>Options</h4><pre tabindex=0><code>-modulus   : Modulus to use for the mod-arith dialect. If not specified, the pass will use the natural modulus for that integer type
-log-scale : Log base 2 of the scale for encoding floating points as ints.
</code></pre><h3 id=-secretize><code>-secretize</code></h3><p><em>Adds secret argument attributes to entry function</em></p><p>Helper pass that adds a secret.secret attribute argument to each function argument.
By default, the pass applies to all functions in the module.
This may be overridden with the option -function=func_name to apply to a single function only.</p><h4 id=options-31>Options</h4><pre tabindex=0><code>-function : function to add secret annotations to
</code></pre><h3 id=-select-rewrite><code>-select-rewrite</code></h3><p><em>Rewrites arith.select to a CMUX style expression</em></p><p>&ldquo;This pass rewrites arith.select %c, %t, %f to %c * %t + (1 - %c) * %f.
It supports all three variants of arith.select: scalar, shaped, and mixed types.
In the latter case, it will broadcast/splat the scalar condition value to the required shape.&rdquo;</p><h3 id=-shape-inference><code>-shape-inference</code></h3><p><em>Infer shapes for shaped types</em></p><p>This pass infers the shapes of shaped types in a function,
starting from function arguments annotated with a {shape.shape} attribute.
Shape inference is only supported for operations that implement InferTypeOpInterface.</p><p>This is primarily intended to be used in conjunction with the Python frontend,
which infers the rank, but not the length of each dimension, for tensor types.</p><h3 id=-straight-line-vectorize><code>-straight-line-vectorize</code></h3><p><em>A vectorizer for straight line programs.</em></p><p>This pass ignores control flow and only vectorizes straight-line programs
within a given region.</p><h4 id=options-32>Options</h4><pre tabindex=0><code>-dialect : Use this to restrict the dialect whose ops should be vectorized.
</code></pre><h3 id=-tensor-ext-to-tensor><code>-tensor-ext-to-tensor</code></h3><p><em>Lower <code>tensor_ext</code> to <code>tensor</code> dialect.</em></p><p>This pass lowers the <code>tensor_ext</code> dialect to the <code>tensor</code> dialect.</p><p>This pass is intended to be used for testing purpose where the
secret arithmetic IR containing <code>tensor_ext</code> dialect is lowered
to the IR containing <code>tensor</code> dialect, which could be further
lowered to the LLVM dialect.</p><h3 id=-tensor-linalg-to-affine-loops><code>-tensor-linalg-to-affine-loops</code></h3><p><em>A port of convert-linalg-to-affine-loops for loops with tensor semantics</em></p><p>This pass primarily exists to support the conversion of <code>linalg.generic</code>
operations that implement <code>tensor_ext.assign_layout</code> ops.</p><h3 id=-tosa-to-secret-arith><code>-tosa-to-secret-arith</code></h3><p><em>Lower <code>tosa.sigmoid</code> to secret arith dialects.</em></p><p>This pass lowers the <code>tosa.sigmoid</code> dialect to the polynomial approximation
-0.004 * x^3 + 0.197 * x + 0.5 (composed of arith, affine, and tensor operations).</p><p>This polynomial approximation of sigmoid only works over the range [-5, 5]
and is taken from the paper <a href=https://eprint.iacr.org/2018/462.pdf>&lsquo;Logisitic regression over encrypted data from
fully homomorphic encryption&rsquo; by Chen et al.</a>.</p><h3 id=-unroll-and-forward><code>-unroll-and-forward</code></h3><p><em>Loop unrolls and forwards stores to loads.</em></p><p>This pass processes the first function in a given module, and, starting from
the first loop, iteratively does the following:</p><ol><li>Fully unroll the loop.</li><li>Scan for load ops. For each load op with a statically-inferrable access
index:</li><li>Backtrack to the original memref alloc</li><li>Find all store ops at the corresponding index (possibly transitively
through renames/subviews of the underlying alloc).</li><li>Find the last store that occurs and forward it to the load.</li><li>If the original memref is an input memref, then forward through any
renames to make the target load load directly from the argument memref
(instead of any subviews, say)</li><li>Apply the same logic to any remaining loads not inside any for loop.</li></ol><p>This pass requires that tensors are lowered to memref, and only supports
affine loops with affine.load/store ops.</p><p>Memrefs that result from memref.get_global ops are excluded from
forwarding, even if they are loaded with a static index, and are instead
handled by memref-global-replace, which should be run after this pass.</p><h3 id=-validate-noise><code>-validate-noise</code></h3><p><em>Validate the HE circuit against a given noise model</em></p><p>This pass validates the noise of the HE circuit against a given noise model.</p><p>The pass expects the scheme parameters to be annotated in the IR. Usually
this is done by the <code>generate-param-&lt;scheme></code> passes.</p><p>For available noise models, see <code>generate-param-&lt;scheme></code> passes.</p><p>The result should be observed using &ndash;debug-only=ValidateNoise.</p><p>Example</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># with commandline --debug-only=ValidateNoise</span>
</span></span><span style=display:flex><span>Noise Bound: 29.27 Budget: 149.73 Total: 179.00 <span style=color:#204a87;font-weight:700>for</span> value: &lt;block argument&gt; of <span style=color:#204a87>type</span> <span style=color:#4e9a06>&#39;tensor&lt;8xi16&gt;&#39;</span> at index: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>Noise Bound: 29.27 Budget: 149.73 Total: 179.00 <span style=color:#204a87;font-weight:700>for</span> value: &lt;block argument&gt; of <span style=color:#204a87>type</span> <span style=color:#4e9a06>&#39;tensor&lt;8xi16&gt;&#39;</span> at index: <span style=color:#0000cf;font-weight:700>1</span>
</span></span></code></pre></div><h4 id=options-33>Options</h4><pre tabindex=0><code>-model                : Noise model to validate against.
-annotate-noise-bound : Annotate the noise bound to the IR.
</code></pre><h3 id=-wrap-generic><code>-wrap-generic</code></h3><p><em>Wraps regions using secret args in secret.generic bodies</em></p><p>This pass converts functions (<code>func.func</code>) with <code>{secret.secret}</code> annotated arguments
to use <code>!secret.secret&lt;...></code> types and wraps the function body in a <code>secret.generic</code> region.
The output type is also converted to <code>!secret.secret&lt;...></code>.</p><p>Example input:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i32</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>100</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>100</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>      secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=-yosys-optimizer><code>-yosys-optimizer</code></h3><p><em>Invoke Yosys to perform circuit optimization.</em></p><p>This pass invokes Yosys to convert an arithmetic circuit to an optimized
boolean circuit that uses the arith and comb dialects.</p><p>Note that booleanization changes the function signature: multi-bit integers
are transformed to a tensor of booleans, for example, an <code>i8</code> is converted
to <code>tensor&lt;8xi1></code>.</p><p>The optimizer will be applied to each <code>secret.generic</code> op containing
arithmetic ops that can be optimized.</p><p>Optional parameters:</p><ul><li><code>abc-fast</code>: Run the abc optimizer in &ldquo;fast&rdquo; mode, getting faster compile
time at the expense of a possibly larger output circuit.</li><li><code>unroll-factor</code>: Before optimizing the circuit, unroll loops by a given
factor. If unset, this pass will not unroll any loops.</li><li><code>print-stats</code>: Prints statistics about the optimized circuits.</li><li><code>mode={Boolean,LUT}</code>: Map gates to boolean gates or lookup table gates.</li><li><code>use-submodules</code>: Extract the body of a generic op into submodules.
Useful for large programs with generics that can be isolated. This should
not be used when distributing generics through loops to avoid index
arguments in the function body.</li></ul><h4 id=statistics>Statistics</h4><pre tabindex=0><code>total circuit size : The total circuit size for all optimized circuits, after optimization is done.
</code></pre><div class="text-muted mt-5 pt-3 border-top">Last modified October 21, 2024: <a href=https://github.com/google/heir/commit/64099177b4adc7b62176c03a7574b0604b6b0bed>convert bash script for docs to python (64099177)</a></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/google/heir aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2025 The HEIR Authors All Rights Reserved</span>
<span class=ms-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.027d75d71824837bee74c12a7806c5fe51249c1ca7accc27553a251a75cdb3a4.js integrity="sha256-An111xgkg3vudMEqeAbF/lEknBynrMwnVTolGnXNs6Q=" crossorigin=anonymous></script>
<script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>